<!-- templates/admin.html -->
{% extends "base.html" %}

{% block title %}Panel de Administraci√≥n{% endblock %}

{% block content %}
<div class="main-container">
    <h1 class="text-center mb-4">
        <i class="icon icon-settings icon-xl"></i>
        Panel de Administraci√≥n
    </h1>
    
    <!-- Estad√≠sticas r√°pidas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card">
                <h3>{{ personas|length }}</h3>
                <p class="mb-0">
                    <i class="icon icon-users icon-white"></i>
                    Personas Total
                </p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <h3>{{ relaciones|length }}</h3>
                <p class="mb-0">
                    <i class="icon icon-connections icon-white"></i>
                    Relaciones Total
                </p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <h3>{{ ((relaciones|length / ((personas|length * (personas|length - 1)) / 2)) * 100)|round(1) if personas|length > 1 else 0 }}%</h3>
                <p class="mb-0">
                    <i class="icon icon-chart icon-white"></i>
                    Densidad Red
                </p>
            </div>
        </div>
    </div>
    
    <!-- Formularios para agregar datos -->
    <div class="row">
        <div class="col-md-6">
            <div class="admin-panel">
                <h4>
                    <i class="icon icon-user"></i>
                    Agregar Nueva Persona
                </h4>
                <form method="POST" action="{{ url_for('agregar_persona') }}">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" name="nombre" required placeholder="Ej: Juan P√©rez">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Emoji</label>
                            <input type="text" class="form-control" name="emoji" placeholder="üòä" maxlength="2">
                            <small class="text-muted">Opcional - Representa a la persona</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color</label>
                            <input type="color" class="form-control" name="color" value="#4ecdc4">
                            <small class="text-muted">Color del nodo en el grafo</small>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Grupo Social</label>
                        <select class="form-control" name="grupo">
                            <option value="amigos">
                                <i class="icon icon-users"></i>
                                üë´ Amigos
                            </option>
                            <option value="familia_cercana">
                                <i class="icon icon-family"></i>
                                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia Cercana
                            </option>
                            <option value="trabajo">
                                <i class="icon icon-briefcase"></i>
                                üíº Trabajo
                            </option>
                            <option value="universidad">
                                <i class="icon icon-academic"></i>
                                üéì Universidad
                            </option>
                            <option value="deportes">
                                <i class="icon icon-fitness"></i>
                                ‚öΩ Deportes
                            </option>
                            <option value="vecinos">
                                <i class="icon icon-home"></i>
                                üè† Vecinos
                            </option>
                            <option value="nuevo">‚ú® Nuevo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea class="form-control" name="descripcion" rows="2" placeholder="Ej: Compa√±ero de trabajo desde 2020, fan del f√∫tbol"></textarea>
                        <small class="text-muted">Informaci√≥n adicional sobre esta persona</small>
                    </div>
                    <button type="submit" class="btn btn-success btn-custom w-100">
                        <i class="icon icon-plus icon-white"></i>
                        Agregar Persona
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Formulario para agregar relaci√≥n -->
        <div class="col-md-6">
            <div class="admin-panel">
                <h4>
                    <i class="icon icon-link"></i>
                    Agregar Nueva Relaci√≥n
                </h4>
                <form method="POST" action="{{ url_for('agregar_relacion') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Persona 1 *</label>
                            <select class="form-control" name="persona1_id" required>
                                <option value="">Seleccionar...</option>
                                {% for persona in personas %}
                                <option value="{{ persona.id }}">{{ persona.emoji }} {{ persona.nombre }}</option>
                                {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de relaciones existentes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="admin-panel">
                <h4>
                    <i class="icon icon-connections"></i>
                    Relaciones Actuales ({{ relaciones|length }})
                </h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Conexi√≥n</th>
                                <th>Tipo</th>
                                <th>Fortaleza</th>
                                <th>Contexto</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for relacion in relaciones %}
                            <tr>
                                <td>
                                    <strong>{{ relacion.persona1_nombre }}</strong> 
                                    <span class="text-muted">‚Üî</span> 
                                    <strong>{{ relacion.persona2_nombre }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ relacion.tipo.replace('_', ' ').title() }}</span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px; width: 80px;">
                                        <div class="progress-bar{% if relacion.fortaleza >= 8 %} bg-success{% elif relacion.fortaleza >= 6 %} bg-warning{% elif relacion.fortaleza >= 4 %} bg-info{% else %} bg-secondary{% endif %}" 
                                            style="width: {{ relacion.fortaleza * 10 }}%;">
                                            {{ relacion.fortaleza }}/10
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <small>{{ relacion.contexto or 'Sin contexto espec√≠fico' }}</small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ relacion.fecha_creacion[:10] if relacion.fecha_creacion else 'N/A' }}</small>
                                </td>
                                <td>
                                    <a href="{{ url_for('eliminar_relacion', relacion_id=relacion.id) }}" 
                                       class="btn btn-sm btn-danger"
                                       onclick="return confirm('¬øEliminar la relaci√≥n entre {{ relacion.persona1_nombre }} y {{ relacion.persona2_nombre }}?')">
                                       <i class="icon icon-trash icon-white icon-sm"></i>
                                       Eliminar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if relaciones|length == 0 %}
                <div class="text-center py-4">
                    <p class="text-muted">No hay relaciones creadas a√∫n. ¬°Agrega algunas usando el formulario de arriba!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Botones de acci√≥n r√°pida -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('index') }}" class="btn btn-success btn-custom btn-lg me-3">
                <i class="icon icon-chart icon-white"></i>
                Ver Grafo Actualizado
            </a>
            <a href="/api/grafo" target="_blank" class="btn btn-info btn-custom me-3">
                <i class="icon icon-code icon-white"></i>
                Ver Datos JSON
            </a>
            <button class="btn btn-warning btn-custom" onclick="location.reload()">
                <i class="icon icon-refresh icon-white"></i>
                Recargar Panel
            </button>
        </div>
    </div>
    
    <!-- Tips de uso -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="admin-panel">
                <h5>
                    <i class="icon icon-lightning"></i>
                    Tips de Uso:
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul>
                            <li><strong>Fortaleza:</strong> 1-3 = Conocidos, 4-6 = Amigos, 7-8 = Buenos amigos, 9-10 = Familia/Mejores amigos</li>
                            <li><strong>Colores:</strong> Elige colores similares para grupos relacionados</li>
                            <li><strong>Emojis:</strong> Ayudan a identificar r√°pidamente a las personas</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li><strong>Contexto:</strong> Describe c√≥mo se conocen las personas</li>
                            <li><strong>Grupos:</strong> Facilitan el an√°lisis visual de la red</li>
                            <li><strong>Centro:</strong> "T√∫" no se puede eliminar, es el centro de tu red</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Validaci√≥n de formularios
document.addEventListener('DOMContentLoaded', function() {
    // Evitar que se seleccione la misma persona en ambos campos de relaci√≥n
    const persona1 = document.querySelector('select[name="persona1_id"]');
    const persona2 = document.querySelector('select[name="persona2_id"]');
    
    if (persona1 && persona2) {
        persona1.addEventListener('change', function() {
            const selectedValue = this.value;
            Array.from(persona2.options).forEach(option => {
                if (option.value === selectedValue && selectedValue !== '') {
                    option.disabled = true;
                    option.style.color = '#ccc';
                } else {
                    option.disabled = false;
                    option.style.color = '';
                }
            });
        });
        
        persona2.addEventListener('change', function() {
            const selectedValue = this.value;
            Array.from(persona1.options).forEach(option => {
                if (option.value === selectedValue && selectedValue !== '') {
                    option.disabled = true;
                    option.style.color = '#ccc';
                } else {
                    option.disabled = false;
                    option.style.color = '';
                }
            });
        });
    }
    
    // Auto-focus en primer campo de formularios
    const firstInput = document.querySelector('input[name="nombre"]');
    if (firstInput) {
        firstInput.focus();
    }
    
    // Validaci√≥n adicional antes de enviar
    const formRelacion = document.querySelector('form[action*="agregar_relacion"]');
    if (formRelacion) {
        formRelacion.addEventListener('submit', function(e) {
            const p1 = document.querySelector('select[name="persona1_id"]').value;
            const p2 = document.querySelector('select[name="persona2_id"]').value;
            
            if (p1 === p2 && p1 !== '') {
                e.preventDefault();
                alert('‚ùå No puedes crear una relaci√≥n de una persona consigo misma');
                return false;
            }
            
            if (!p1 || !p2) {
                e.preventDefault();
                alert('‚ùå Debes seleccionar ambas personas para crear la relaci√≥n');
                return false;
            }
        });
    }
    
    // Validaci√≥n de emoji (m√°ximo 2 caracteres)
    const emojiInput = document.querySelector('input[name="emoji"]');
    if (emojiInput) {
        emojiInput.addEventListener('input', function() {
            if (this.value.length > 2) {
                this.value = this.value.slice(0, 2);
            }
        });
    }
    
    // Validaci√≥n de nombre (no vac√≠o y longitud razonable)
    const nombreInput = document.querySelector('input[name="nombre"]');
    if (nombreInput) {
        nombreInput.addEventListener('blur', function() {
            if (this.value.trim().length < 2) {
                this.style.borderColor = '#dc3545';
                this.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';
            } else {
                this.style.borderColor = '';
                this.style.boxShadow = '';
            }
        });
    }
});

// Funci√≥n para confirmar eliminaciones
function confirmarEliminacion(tipo, nombre) {
    return confirm(`¬øEst√°s seguro de que quieres eliminar ${tipo} "${nombre}"? Esta acci√≥n no se puede deshacer.`);
}

// Funci√≥n para mostrar preview del color seleccionado
document.addEventListener('DOMContentLoaded', function() {
    const colorInput = document.querySelector('input[name="color"]');
    if (colorInput) {
        colorInput.addEventListener('change', function() {
            const preview = document.createElement('div');
            preview.style.width = '20px';
            preview.style.height = '20px';
            preview.style.backgroundColor = this.value;
            preview.style.borderRadius = '50%';
            preview.style.display = 'inline-block';
            preview.style.marginLeft = '10px';
            preview.style.border = '2px solid #ccc';
            
            // Remover preview anterior si existe
            const oldPreview = this.parentNode.querySelector('.color-preview');
            if (oldPreview) {
                oldPreview.remove();
            }
            
            preview.className = 'color-preview';
            this.parentNode.appendChild(preview);
        });
    }
});
</script>
{% endblock %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Persona 2 *</label>
                            <select class="form-control" name="persona2_id" required>
                                <option value="">Seleccionar...</option>
                                {% for persona in personas %}
                                <option value="{{ persona.id }}">{{ persona.emoji }} {{ persona.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Relaci√≥n</label>
                            <select class="form-control" name="tipo">
                                <option value="amistad">üë´ Amistad</option>
                                <option value="mejor_amigo">üíñ Mejor Amigo/a</option>
                                <option value="familia">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Familia</option>
                                <option value="trabajo">üíº Trabajo</option>
                                <option value="universidad">üéì Universidad</option>
                                <option value="deportes">‚öΩ Deportes</option>
                                <option value="vecinos">üè† Vecinos</option>
                                <option value="pareja">üíï Pareja</option>
                                <option value="conocidos">ü§ù Conocidos</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fortaleza (1-10)</label>
                            <input type="number" class="form-control" name="fortaleza" min="1" max="10" value="5">
                            <small class="text-muted">1=D√©bil, 10=Muy fuerte</small>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Contexto</label>
                        <input type="text" class="form-control" name="contexto" placeholder="Ej: Se conocieron en el gimnasio">
                        <small class="text-muted">¬øC√≥mo se conocen o relacionan?</small>
                    </div>
                    <button type="submit" class="btn btn-primary btn-custom w-100">
                        <i class="icon icon-link icon-white"></i>
                        Crear Relaci√≥n
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Lista de personas existentes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="admin-panel">
                <h4>
                    <i class="icon icon-users"></i>
                    Personas en tu Red ({{ personas|length }})
                </h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Persona</th>
                                <th>Grupo</th>
                                <th>Descripci√≥n</th>
                                <th>Fecha Agregada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for persona in personas %}
                            <tr>
                                <td><span class="badge bg-light text-dark">{{ persona.id }}</span></td>
                                <td>
                                    <span style="color: {{ persona.color }}; font-size: 1.2em">{{ persona.emoji }}</span>
                                    <strong>{{ persona.nombre }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ persona.grupo.replace('_', ' ').title() }}</span>
                                </td>
                                <td>
                                    <small>{{ persona.descripcion or 'Sin descripci√≥n' }}</small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ persona.fecha_creacion[:10] if persona.fecha_creacion else 'N/A' }}</small>
                                </td>
                                <td>
                                    {% if persona.nombre != 'T√∫' %}
                                    <a href="{{ url_for('eliminar_persona', persona_id=persona.id) }}" 
                                       class="btn btn-sm btn-danger"
                                       onclick="return confirm('¬øEst√°s seguro de eliminar a {{ persona.nombre }}? Se eliminar√°n tambi√©n todas sus relaciones.')">
                                       <i class="icon icon-trash icon-white icon-sm"></i>
                                       Eliminar
                                    </a>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="icon icon-crown icon-sm"></i>
                                        Centro de la Red
                                    </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}