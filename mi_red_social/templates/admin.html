<!-- templates/admin.html -->
{% extends "base.html" %}

{% block title %}Panel de Administración{% endblock %}

{% block content %}
<div class="main-container">
    <h1 class="text-center mb-4">⚙️ Panel de Administración</h1>
    
    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card">
                <h3>{{ personas|length }}</h3>
                <p class="mb-0">👥 Personas Total</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <h3>{{ relaciones|length }}</h3>
                <p class="mb-0">🔗 Relaciones Total</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card">
                <h3>{{ ((relaciones|length / ((personas|length * (personas|length - 1)) / 2)) * 100)|round(1) if personas|length > 1 else 0 }}%</h3>
                <p class="mb-0">📊 Densidad Red</p>
            </div>
        </div>
    </div>
    
    <!-- Formularios para agregar datos -->
    <div class="row">
        <div class="col-md-6">
            <div class="admin-panel">
                <h4>👤 Agregar Nueva Persona</h4>
                <form method="POST" action="{{ url_for('agregar_persona') }}">
                    <div class="mb-3">
                        <label class="form-label">Nombre *</label>
                        <input type="text" class="form-control" name="nombre" required placeholder="Ej: Juan Pérez">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Emoji</label>
                            <input type="text" class="form-control" name="emoji" placeholder="😊" maxlength="2">
                            <small class="text-muted">Opcional - Representa a la persona</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Color</label>
                            <input type="color" class="form-control" name="color" value="#4ecdc4">
                            <small class="text-muted">Color del nodo en el grafo</small>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Grupo Social</label>
                        <select class="form-control" name="grupo">
                            <option value="amigos">👫 Amigos</option>
                            <option value="familia_cercana">👨‍👩‍👧‍👦 Familia Cercana</option>
                            <option value="trabajo">💼 Trabajo</option>
                            <option value="universidad">🎓 Universidad</option>
                            <option value="deportes">⚽ Deportes</option>
                            <option value="vecinos">🏠 Vecinos</option>
                            <option value="nuevo">✨ Nuevo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" name="descripcion" rows="2" placeholder="Ej: Compañero de trabajo desde 2020, fan del fútbol"></textarea>
                        <small class="text-muted">Información adicional sobre esta persona</small>
                    </div>
                    <button type="submit" class="btn btn-success btn-custom w-100">➕ Agregar Persona</button>
                </form>
            </div>
        </div>
        
        <!-- Formulario para agregar relación -->
        <div class="col-md-6">
            <div class="admin-panel">
                <h4>🔗 Agregar Nueva Relación</h4>
                <form method="POST" action="{{ url_for('agregar_relacion') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Persona 1 *</label>
                            <select class="form-control" name="persona1_id" required>
                                <option value="">Seleccionar...</option>
                                {% for persona in personas %}
                                <option value="{{ persona.id }}">{{ persona.emoji }} {{ persona.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Persona 2 *</label>
                            <select class="form-control" name="persona2_id" required>
                                <option value="">Seleccionar...</option>
                                {% for persona in personas %}
                                <option value="{{ persona.id }}">{{ persona.emoji }} {{ persona.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Relación</label>
                            <select class="form-control" name="tipo">
                                <option value="amistad">👫 Amistad</option>
                                <option value="mejor_amigo">💖 Mejor Amigo/a</option>
                                <option value="familia">👨‍👩‍👧‍👦 Familia</option>
                                <option value="trabajo">💼 Trabajo</option>
                                <option value="universidad">🎓 Universidad</option>
                                <option value="deportes">⚽ Deportes</option>
                                <option value="vecinos">🏠 Vecinos</option>
                                <option value="pareja">💕 Pareja</option>
                                <option value="conocidos">🤝 Conocidos</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Fortaleza (1-10)</label>
                            <input type="number" class="form-control" name="fortaleza" min="1" max="10" value="5">
                            <small class="text-muted">1=Débil, 10=Muy fuerte</small>
                        </div>
                    </div>
                    <div class="mb-3 mt-3">
                        <label class="form-label">Contexto</label>
                        <input type="text" class="form-control" name="contexto" placeholder="Ej: Se conocieron en el gimnasio">
                        <small class="text-muted">¿Cómo se conocen o relacionan?</small>
                    </div>
                    <button type="submit" class="btn btn-primary btn-custom w-100">🔗 Crear Relación</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Lista de personas existentes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="admin-panel">
                <h4>👥 Personas en tu Red ({{ personas|length }})</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Persona</th>
                                <th>Grupo</th>
                                <th>Descripción</th>
                                <th>Fecha Agregada</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for persona in personas %}
                            <tr>
                                <td><span class="badge bg-light text-dark">{{ persona.id }}</span></td>
                                <td>
                                    <span style="color: {{ persona.color }}; font-size: 1.2em;">{{ persona.emoji }}</span>
                                    <strong>{{ persona.nombre }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ persona.grupo.replace('_', ' ').title() }}</span>
                                </td>
                                <td>
                                    <small>{{ persona.descripcion or 'Sin descripción' }}</small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ persona.fecha_creacion[:10] if persona.fecha_creacion else 'N/A' }}</small>
                                </td>
                                <td>
                                    {% if persona.nombre != 'Tú' %}
                                    <a href="{{ url_for('eliminar_persona', persona_id=persona.id) }}" 
                                       class="btn btn-sm btn-danger"
                                       onclick="return confirm('¿Estás seguro de eliminar a {{ persona.nombre }}? Se eliminarán también todas sus relaciones.')">
                                       🗑️ Eliminar
                                    </a>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">👑 Centro de la Red</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de relaciones existentes -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="admin-panel">
                <h4>🔗 Relaciones Actuales ({{ relaciones|length }})</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Conexión</th>
                                <th>Tipo</th>
                                <th>Fortaleza</th>
                                <th>Contexto</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for relacion in relaciones %}
                            <tr>
                                <td>
                                    <strong>{{ relacion.persona1_nombre }}</strong> 
                                    <span class="text-muted">↔</span> 
                                    <strong>{{ relacion.persona2_nombre }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ relacion.tipo.replace('_', ' ').title() }}</span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px; width: 80px;">
                                        <div class="progress-bar{% if relacion.fortaleza >= 8 %} bg-success{% elif relacion.fortaleza >= 6 %} bg-warning{% elif relacion.fortaleza >= 4 %} bg-info{% else %} bg-secondary{% endif %}" 
                                            style="width: {{ relacion.fortaleza * 10 }}%;">
                                            {{ relacion.fortaleza }}/10
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <small>{{ relacion.contexto or 'Sin contexto específico' }}</small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ relacion.fecha_creacion[:10] if relacion.fecha_creacion else 'N/A' }}</small>
                                </td>
                                <td>
                                    <a href="{{ url_for('eliminar_relacion', relacion_id=relacion.id) }}" 
                                       class="btn btn-sm btn-danger"
                                       onclick="return confirm('¿Eliminar la relación entre {{ relacion.persona1_nombre }} y {{ relacion.persona2_nombre }}?')">
                                       🗑️ Eliminar
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if relaciones|length == 0 %}
                <div class="text-center py-4">
                    <p class="text-muted">No hay relaciones creadas aún. ¡Agrega algunas usando el formulario de arriba!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Botones de acción rápida -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('index') }}" class="btn btn-success btn-custom btn-lg me-3">
                📊 Ver Grafo Actualizado
            </a>
            <a href="/api/grafo" target="_blank" class="btn btn-info btn-custom me-3">
                🔧 Ver Datos JSON
            </a>
            <button class="btn btn-warning btn-custom" onclick="location.reload()">
                🔄 Recargar Panel
            </button>
        </div>
    </div>
    
    <!-- Tips de uso -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="admin-panel">
                <h5>💡 Tips de Uso:</h5>
                <div class="row">
                    <div class="col-md-6">
                        <ul>
                            <li><strong>Fortaleza:</strong> 1-3 = Conocidos, 4-6 = Amigos, 7-8 = Buenos amigos, 9-10 = Familia/Mejores amigos</li>
                            <li><strong>Colores:</strong> Elige colores similares para grupos relacionados</li>
                            <li><strong>Emojis:</strong> Ayudan a identificar rápidamente a las personas</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li><strong>Contexto:</strong> Describe cómo se conocen las personas</li>
                            <li><strong>Grupos:</strong> Facilitan el análisis visual de la red</li>
                            <li><strong>Centro:</strong> "Tú" no se puede eliminar, es el centro de tu red</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Validación de formularios
document.addEventListener('DOMContentLoaded', function() {
    // Evitar que se seleccione la misma persona en ambos campos de relación
    const persona1 = document.querySelector('select[name="persona1_id"]');
    const persona2 = document.querySelector('select[name="persona2_id"]');
    
    if (persona1 && persona2) {
        persona1.addEventListener('change', function() {
            const selectedValue = this.value;
            Array.from(persona2.options).forEach(option => {
                if (option.value === selectedValue && selectedValue !== '') {
                    option.disabled = true;
                    option.style.color = '#ccc';
                } else {
                    option.disabled = false;
                    option.style.color = '';
                }
            });
        });
        
        persona2.addEventListener('change', function() {
            const selectedValue = this.value;
            Array.from(persona1.options).forEach(option => {
                if (option.value === selectedValue && selectedValue !== '') {
                    option.disabled = true;
                    option.style.color = '#ccc';
                } else {
                    option.disabled = false;
                    option.style.color = '';
                }
            });
        });
    }
    
    // Auto-focus en primer campo de formularios
    const firstInput = document.querySelector('input[name="nombre"]');
    if (firstInput) {
        firstInput.focus();
    }
    
    // Validación adicional antes de enviar
    const formRelacion = document.querySelector('form[action*="agregar_relacion"]');
    if (formRelacion) {
        formRelacion.addEventListener('submit', function(e) {
            const p1 = document.querySelector('select[name="persona1_id"]').value;
            const p2 = document.querySelector('select[name="persona2_id"]').value;
            
            if (p1 === p2 && p1 !== '') {
                e.preventDefault();
                alert('❌ No puedes crear una relación de una persona consigo misma');
                return false;
            }
            
            if (!p1 || !p2) {
                e.preventDefault();
                alert('❌ Debes seleccionar ambas personas para crear la relación');
                return false;
            }
        });
    }
});

// Función para confirmar eliminaciones
function confirmarEliminacion(tipo, nombre) {
    return confirm(`¿Estás seguro de que quieres eliminar ${tipo} "${nombre}"? Esta acción no se puede deshacer.`);
}
</script>
{% endblock %}