<!-- templates/index.html - VERSIÓN CORREGIDA CON PERSISTENCIA -->
{% extends "base.html" %}

{% block title %}Análisis de Red de Relaciones{% endblock %}

{% block content %}
<div class="main-container main-container-fullscreen">
    
    <!-- Estadísticas principales -->
    <div class="row mb-2 stats-row">
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="total-personas">0</h4>
                <p class="mb-0">
                    <i class="icon icon-users icon-white"></i>
                    Contactos
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="total-conexiones">0</h4>
                <p class="mb-0">
                    <i class="icon icon-connections icon-white"></i>
                    Conexiones
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="densidad-red">0%</h4>
                <p class="mb-0">
                    <i class="icon icon-chart icon-white"></i>
                    Densidad
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h5 id="mas-conectado" class="nombre-conectado">Cargando...</h5>
                <p class="mb-0">
                    <i class="icon icon-crown icon-white"></i>
                    Más Conectado
                </p>
            </div>
        </div>
    </div>    

    <!-- Contenedor del grafo -->
    <div class="row network-row">
        <div class="col-12 network-col">
            <div class="admin-panel admin-panel-compact">

                <!-- Controles principales -->
                <div class="controls-container">
                    <!-- Fila 1: Controles básicos del grafo -->
                    <div class="controls-row mb-2">
                        <button class="btn btn-success btn-custom btn-sm me-2" onclick="centrarRed()">
                            <i class="icon icon-target icon-sm"></i>
                            Centrar Vista
                        </button>
                        <button class="btn btn-info btn-custom btn-sm me-2" onclick="togglePhysics()">
                            <i class="icon icon-lightning icon-sm"></i>
                            Activar Física
                        </button>
                        <button class="btn btn-warning btn-custom btn-sm me-2" onclick="randomizePositions()">
                            <i class="icon icon-shuffle icon-sm"></i>
                            Reorganizar
                        </button>
                        <button class="btn btn-primary btn-custom btn-sm" onclick="recargarDatos()">
                            <i class="icon icon-refresh icon-sm"></i>
                            Recargar
                        </button>
                    </div>
                    
                    <!-- Fila 2: Controles de grupos y burbujas -->
                    <div class="controls-row">
                        <button class="btn btn-outline-primary btn-custom btn-sm me-2" onclick="toggleBurbujas()">
                            <i class="icon icon-chart icon-sm"></i>
                            Mostrar Grupos
                        </button>
                        <button class="btn btn-outline-success btn-custom btn-sm me-2" onclick="abrirModalGestionGrupos()">
                            <i class="icon icon-settings icon-sm"></i>
                            Gestionar Grupos
                        </button>
                        <button class="btn btn-outline-info btn-custom btn-sm me-2" onclick="mostrarEstadisticasGruposModal()">
                            <i class="icon icon-chart icon-sm"></i>
                            Stats Grupos
                        </button>
                        <button class="btn btn-outline-secondary btn-custom btn-sm" onclick="diagnosticarProblemasPersistencia()">
                            <i class="icon icon-settings icon-sm"></i>
                            Debug
                        </button>
                    </div>
                </div>
                
                <!-- Instrucciones de uso -->
                <div class="alert alert-info mb-3" style="font-size: 0.8rem; padding: 0.5rem;">
                    <div class="row">
                        <div class="col-md-6">
                            <i class="icon icon-plus icon-sm"></i>
                            <strong>Crear Personas:</strong> Haz <strong>doble clic</strong> en cualquier área vacía del grafo para crear una nueva persona.
                        </div>
                        <div class="col-md-6">
                            <i class="icon icon-link icon-sm"></i>
                            <strong>Crear Relaciones:</strong> Pasa el cursor sobre una persona y haz clic en el botón <strong>+</strong> que aparece.
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="col-md-6">
                            <i class="icon icon-chart icon-sm"></i>
                            <strong>Grupos:</strong> Usa <strong>"Gestionar Grupos"</strong> para crear burbujas que agrupen personas por universidad, ciudad, etc.
                        </div>
                        <div class="col-md-6">
                            <i class="icon icon-users icon-sm"></i>
                            <strong>Persistencia:</strong> Los grupos se guardan automáticamente y persisten al recargar la página.
                        </div>
                    </div>
                </div>
                
                <!-- El grafo -->
                <div id="network" class="network-container network-full-height"></div>
                
            </div>
        </div>
    </div>
    
</div>

<!-- Sistema de notificaciones pop-up -->
<div id="notifications-container" class="notifications-container"></div>

{% endblock %}

{% block scripts %}
<!-- Incluir el archivo JavaScript principal -->
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<!-- Incluir el nuevo archivo JavaScript para creación de nodos -->
<script src="{{ url_for('static', filename='js/create-node.js') }}"></script>
<!-- Incluir el nuevo archivo JavaScript para creación de aristas -->
<script src="{{ url_for('static', filename='js/create-edge.js') }}"></script>
<!-- Incluir el sistema de burbujas de grupos CORREGIDO -->
<script src="{{ url_for('static', filename='js/group-bubbles.js') }}"></script>
<!-- Incluir el sistema de gestión de grupos -->
<script src="{{ url_for('static', filename='js/group-management.js') }}"></script>
<!-- Incluir las correcciones de accesibilidad -->
<script src="{{ url_for('static', filename='js/accessibility-fixes.js') }}"></script>
<!-- Incluir la corrección específica para aria-hidden -->
<script src="{{ url_for('static', filename='js/aria-hidden-fix.js') }}"></script>

<!-- NUEVO: Incluir el parche de rendimiento para zoom -->
<script>
// Parche de rendimiento para zoom - INCLUIDO DIRECTAMENTE
console.log('⚡ Cargando parche de rendimiento para zoom...');

// Variables para optimización de rendimiento
let lastTransformTime = 0;
let pendingTransform = false;

// Función optimizada para aplicar transformaciones con throttling
function aplicarTransformacionOptimizada() {
    const now = performance.now();
    const deltaTime = now - lastTransformTime;
    
    // Throttling: no aplicar más de 60fps
    if (deltaTime < 16.67) {
        if (!pendingTransform) {
            pendingTransform = true;
            requestAnimationFrame(() => {
                if (typeof aplicarTransformacionBurbujas === 'function') {
                    aplicarTransformacionBurbujas();
                }
                lastTransformTime = performance.now();
                pendingTransform = false;
            });
        }
        return;
    }
    
    if (typeof aplicarTransformacionBurbujas === 'function') {
        aplicarTransformacionBurbujas();
    }
    lastTransformTime = now;
}

// Mejorar los eventos de zoom después de que el sistema esté listo
function aplicarMejorasZoom() {
    if (!network || typeof burbujasActivas === 'undefined') {
        console.log('⏳ Esperando sistema de burbujas para aplicar mejoras de zoom...');
        setTimeout(aplicarMejorasZoom, 1000);
        return;
    }
    
    console.log('⚡ Aplicando mejoras de rendimiento de zoom...');
    
    // Sobreescribir la función de aplicación de transformación con la versión optimizada
    if (typeof window.aplicarTransformacionBurbujas === 'function') {
        const originalFunction = window.aplicarTransformacionBurbujas;
        
        window.aplicarTransformacionBurbujas = function() {
            // Usar la versión optimizada cuando sea apropiado
            if (pendingTransform) {
                return; // Ya hay una transformación pendiente
            }
            return originalFunction.apply(this, arguments);
        };
        
        console.log('✅ Función de transformación optimizada');
    }
    
    // Función para detectar zoom rápido y optimizar
    let lastZoomTime = 0;
    let zoomCount = 0;
    
    if (network) {
        network.on('zoom', function() {
            const now = performance.now();
            
            // Detectar zoom rápido (más de 3 zooms en 1 segundo)
            if (now - lastZoomTime < 1000) {
                zoomCount++;
            } else {
                zoomCount = 1;
            }
            lastZoomTime = now;
            
            // Si es zoom rápido, usar función optimizada
            if (zoomCount > 3) {
                aplicarTransformacionOptimizada();
            }
        });
        
        console.log('✅ Optimización de zoom rápido configurada');
    }
}

// Aplicar mejoras cuando el DOM esté listo
setTimeout(aplicarMejorasZoom, 3000);

// Función de test para verificar las mejoras
window.testZoomOptimizado = function() {
    console.log('🧪 Probando zoom optimizado...');
    
    if (!network) {
        console.error('❌ Network no disponible');
        return;
    }
    
    let startTime = performance.now();
    let transformCount = 0;
    
    // Interceptar transformaciones para contar
    const original = window.aplicarTransformacionBurbujas;
    window.aplicarTransformacionBurbujas = function() {
        transformCount++;
        return original?.apply(this, arguments);
    };
    
    // Hacer zoom rápido
    const zooms = [0.5, 2, 0.8, 2.5, 1, 1.5, 1];
    let index = 0;
    
    function nextZoom() {
        if (index < zooms.length) {
            network.moveTo({ 
                scale: zooms[index], 
                animation: { duration: 200 } 
            });
            index++;
            setTimeout(nextZoom, 300);
        } else {
            // Mostrar resultados
            const totalTime = performance.now() - startTime;
            console.log(`⚡ Test completado en ${totalTime.toFixed(0)}ms`);
            console.log(`🔄 Transformaciones aplicadas: ${transformCount}`);
            console.log(`📈 FPS efectivo: ${(transformCount / (totalTime / 1000)).toFixed(1)}`);
            
            // Restaurar función original
            window.aplicarTransformacionBurbujas = original;
            
            // Volver a la vista normal
            network.fit({ animation: { duration: 1000 } });
        }
    }
    
    nextZoom();
};

console.log('⚡ Parche de rendimiento de zoom cargado');
</script>

<!-- NUEVOS SCRIPTS PARA PERSISTENCIA -->
<script>
// Incluir aquí las funciones de persistencia directamente en el HTML
// para asegurar que estén disponibles inmediatamente

// Función para enviar updates de grupos al servidor
async function enviarActualizacionesGruposAlServidor(updates) {
    if (!updates || updates.length === 0) {
        console.log('📝 No hay actualizaciones de grupos para enviar');
        return { success: true, message: 'Sin cambios que guardar' };
    }
    
    try {
        console.log('📤 Enviando actualizaciones de grupos al servidor:', updates);
        
        const response = await fetch('/actualizar_grupos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                updates: updates
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('✅ Respuesta del servidor:', result);
        
        return result;
        
    } catch (error) {
        console.error('❌ Error enviando actualizaciones de grupos:', error);
        throw error;
    }
}

// Función para obtener grupos actuales del servidor
async function obtenerGruposDelServidor() {
    try {
        console.log('📥 Obteniendo grupos actuales del servidor...');
        
        const response = await fetch('/obtener_grupos_personas');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('✅ Grupos obtenidos del servidor:', result);
        
        return result.grupos || {};
        
    } catch (error) {
        console.error('❌ Error obteniendo grupos del servidor:', error);
        throw error;
    }
}

// Función para sincronizar grupos al cargar la página
async function sincronizarGruposAlCargar() {
    console.log('🔄 Sincronizando grupos al cargar...');
    
    try {
        // Obtener grupos actuales del servidor
        const gruposServidor = await obtenerGruposDelServidor();
        
        if (!nodes) {
            console.warn('⚠️ Nodes no disponible para sincronización');
            return;
        }
        
        // Comparar con grupos en memoria
        const nodosActuales = nodes.get();
        const actualizacionesNecesarias = [];
        
        nodosActuales.forEach(nodo => {
            const grupoServidor = gruposServidor[nodo.id]?.grupo;
            const grupoActual = nodo.grupo;
            
            if (grupoServidor !== grupoActual) {
                console.log(`🔄 Sincronizando nodo ${nodo.id}: "${grupoActual}" → "${grupoServidor}"`);
                
                actualizacionesNecesarias.push({
                    id: nodo.id,
                    grupo: grupoServidor
                });
            }
        });
        
        if (actualizacionesNecesarias.length > 0) {
            nodes.update(actualizacionesNecesarias);
            console.log(`✅ ${actualizacionesNecesarias.length} grupos sincronizados`);
            
            // Crear burbujas después de sincronizar
            if (typeof crearBurbujasGrupos === 'function') {
                setTimeout(crearBurbujasGrupos, 500);
            }
        } else {
            console.log('✅ Grupos ya sincronizados');
        }
        
    } catch (error) {
        console.error('❌ Error sincronizando grupos:', error);
    }
}

// Función para verificar sincronización
window.verificarSincronizacionGrupos = async function() {
    console.log('🔍 Verificando sincronización de grupos...');
    
    try {
        const gruposServidor = await obtenerGruposDelServidor();
        
        if (!nodes) {
            console.log('❌ Nodes no disponible');
            return false;
        }
        
        const nodosActuales = nodes.get();
        
        console.log('📊 COMPARACIÓN DE GRUPOS:');
        console.log('========================');
        
        let diferencias = 0;
        
        nodosActuales.forEach(nodo => {
            const grupoMemoria = nodo.grupo || 'sin_grupo';
            const grupoServidor = gruposServidor[nodo.id]?.grupo || 'sin_grupo';
            const nombre = nodo.label?.replace(/<[^>]*>/g, '') || `Nodo ${nodo.id}`;
            
            if (grupoMemoria !== grupoServidor) {
                console.log(`❌ ${nombre}: Memoria="${grupoMemoria}" vs Servidor="${grupoServidor}"`);
                diferencias++;
            } else {
                console.log(`✅ ${nombre}: "${grupoMemoria}" (sincronizado)`);
            }
        });
        
        console.log('========================');
        console.log(`📈 Resultado: ${diferencias === 0 ? '✅ Totalmente sincronizado' : `❌ ${diferencias} diferencias encontradas`}`);
        
        return diferencias === 0;
        
    } catch (error) {
        console.error('❌ Error verificando sincronización:', error);
        return false;
    }
};

// Función para diagnosticar problemas
window.diagnosticarProblemasPersistencia = async function() {
    console.log('🔍 DIAGNÓSTICO DE PERSISTENCIA:');
    console.log('==============================');
    
    const problemas = [];
    
    // 1. Verificar backend
    try {
        const response = await fetch('/actualizar_grupos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates: [] })
        });
        
        if (response.ok) {
            console.log('✅ Endpoint /actualizar_grupos disponible');
        } else {
            problemas.push('❌ Endpoint /actualizar_grupos no responde correctamente');
        }
    } catch (error) {
        problemas.push('❌ No se puede conectar con /actualizar_grupos: ' + error.message);
    }
    
    // 2. Verificar obtener grupos
    try {
        const grupos = await obtenerGruposDelServidor();
        console.log(`✅ Endpoint /obtener_grupos_personas disponible (${Object.keys(grupos).length} personas)`);
    } catch (error) {
        problemas.push('❌ Error obteniendo grupos del servidor: ' + error.message);
    }
    
    // 3. Verificar dependencias
    if (typeof nodes === 'undefined' || !nodes) {
        problemas.push('❌ Variable nodes no disponible');
    } else {
        console.log(`✅ Nodes disponible (${nodes.length} nodos)`);
    }
    
    if (typeof network === 'undefined' || !network) {
        problemas.push('❌ Variable network no disponible');
    } else {
        console.log('✅ Network disponible');
    }
    
    console.log('==============================');
    
    if (problemas.length === 0) {
        console.log('🎉 ¡No se encontraron problemas de persistencia!');
        await verificarSincronizacionGrupos();
    } else {
        console.log('🚨 PROBLEMAS ENCONTRADOS:');
        problemas.forEach(problema => console.log(problema));
        mostrarNotificacion('error', 'Se encontraron problemas en el sistema de persistencia. Revisa la consola.');
    }
    
    return problemas.length === 0;
};

// Exportar funciones globalmente
window.enviarActualizacionesGruposAlServidor = enviarActualizacionesGruposAlServidor;
window.obtenerGruposDelServidor = obtenerGruposDelServidor;
window.sincronizarGruposAlCargar = sincronizarGruposAlCargar;

console.log('💾 Sistema de persistencia de grupos cargado directamente');
</script>

<!-- Script CORREGIDO para integración - SIN RECURSIÓN -->
<script>
console.log('🚀 Iniciando scripts de integración con persistencia...');

// Función CORREGIDA para mostrar estadísticas de grupos - SIN RECURSIÓN
window.mostrarEstadisticasGruposModal = function() {
    console.log('📊 Abriendo modal de estadísticas de grupos...');
    
    // Verificar que los sistemas estén disponibles
    if (typeof obtenerEstadisticasGrupos !== 'function') {
        console.warn('⚠️ Función obtenerEstadisticasGrupos no disponible');
        mostrarNotificacion('warning', 'Sistema de estadísticas no disponible aún. Intenta en unos segundos.');
        return;
    }
    
    try {
        // Llamar a la función SIN recursión - usando la función global
        const stats = obtenerEstadisticasGrupos();
        console.log('📊 Estadísticas obtenidas:', stats);
        console.table(stats);
        
        // Crear modal para mostrar estadísticas
        let html = `
            <div class="modal fade" id="modalEstadisticasGrupos" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="icon icon-chart"></i>
                                Estadísticas de Grupos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Grupo</th>
                                            <th>Nodos</th>
                                            <th>Conexiones Internas</th>
                                            <th>Conexiones Externas</th>
                                            <th>Densidad Interna</th>
                                            <th>Color</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        if (Object.keys(stats).length === 0) {
            html += '<tr><td colspan="6" class="text-center text-muted">No hay grupos con datos suficientes</td></tr>';
        } else {
            Object.entries(stats).forEach(([grupo, data]) => {
                const nombreFormateado = typeof formatearNombreGrupo === 'function' ? formatearNombreGrupo(grupo) : grupo;
                html += `
                    <tr>
                        <td><strong>${nombreFormateado}</strong></td>
                        <td><span class="badge bg-primary">${data.nodos}</span></td>
                        <td><span class="badge bg-success">${data.conexionesInternas}</span></td>
                        <td><span class="badge bg-info">${data.conexionesExternas}</span></td>
                        <td><span class="badge bg-warning">${data.densidad}</span></td>
                        <td>
                            <div style="width: 20px; height: 20px; background: ${data.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        </td>
                    </tr>
                `;
            });
        }
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <h6><i class="icon icon-chart"></i> Explicación:</h6>
                                <ul class="mb-0">
                                    <li><strong>Nodos:</strong> Cantidad de personas en el grupo</li>
                                    <li><strong>Conexiones Internas:</strong> Relaciones entre miembros del mismo grupo</li>
                                    <li><strong>Conexiones Externas:</strong> Relaciones con personas de otros grupos</li>
                                    <li><strong>Densidad Interna:</strong> Porcentaje de conexiones internas respecto al máximo posible</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="if(typeof crearBurbujasGrupos === 'function') crearBurbujasGrupos()">
                                <i class="icon icon-refresh"></i> Actualizar Burbujas
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Limpiar modal anterior
        const modalAnterior = document.getElementById('modalEstadisticasGrupos');
        if (modalAnterior) {
            modalAnterior.remove();
        }
        
        // Agregar y mostrar nuevo modal
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('modalEstadisticasGrupos'));
        modal.show();
        
        console.log('✅ Modal de estadísticas mostrado correctamente');
        
    } catch (error) {
        console.error('❌ Error obteniendo estadísticas:', error);
        mostrarNotificacion('error', 'Error al obtener estadísticas de grupos: ' + error.message);
    }
};

// Función para demostración de grupos
window.crearGruposDemo = function() {
    console.log('🧪 Creando grupos de demostración...');
    
    if (!nodes) {
        console.error('❌ Nodes no disponible');
        mostrarNotificacion('error', 'Sistema de nodos no disponible');
        return;
    }
    
    // Obtener todos los nodos
    const todosLosNodos = nodes.get();
    
    if (todosLosNodos.length < 4) {
        console.log('⚠️ Se necesitan al menos 4 nodos para la demo');
        mostrarNotificacion('info', 'Agrega más personas para ver una mejor demostración de grupos');
        return;
    }
    
    // Asignar grupos de ejemplo
    const updates = [];
    
    todosLosNodos.forEach((nodo, index) => {
        let grupo = null;
        
        // Distribuir nodos en grupos de ejemplo
        if (index % 4 === 0) {
            grupo = 'universidad';
        } else if (index % 4 === 1) {
            grupo = 'trabajo';
        } else if (index % 4 === 2) {
            grupo = 'cadiz';
        } else {
            grupo = 'amigos';
        }
        
        updates.push({
            id: nodo.id,
            grupo: grupo
        });
    });
    
    // Aplicar cambios en frontend
    nodes.update(updates);
    
    // Enviar cambios al servidor para persistencia
    enviarActualizacionesGruposAlServidor(updates).then(resultado => {
        if (resultado.success) {
            console.log('✅ Grupos demo guardados en servidor');
            
            // Crear burbujas
            setTimeout(() => {
                if (typeof crearBurbujasGrupos === 'function') {
                    crearBurbujasGrupos();
                    console.log('✅ Burbujas de grupos creadas');
                }
            }, 500);
            
            mostrarNotificacion('success', '¡Grupos de demostración creados y guardados! Ahora puedes ver las burbujas de colores.');
        } else {
            console.error('❌ Error guardando grupos demo');
            mostrarNotificacion('error', 'Error guardando grupos de demostración');
        }
    }).catch(error => {
        console.error('❌ Error enviando grupos demo al servidor:', error);
        mostrarNotificacion('error', 'Error de conexión al guardar grupos demo');
    });
    
    console.log('✅ Grupos demo aplicados a', updates.length, 'nodos');
};

// Función para limpiar grupos demo
window.limpiarGruposDemo = function() {
    console.log('🧹 Limpiando grupos de demostración...');
    
    if (!nodes) {
        console.error('❌ Nodes no disponible');
        return;
    }
    
    const todosLosNodos = nodes.get();
    const updates = todosLosNodos.map(nodo => ({
        id: nodo.id,
        grupo: null
    }));
    
    // Aplicar cambios en frontend
    nodes.update(updates);
    
    // Enviar cambios al servidor
    enviarActualizacionesGruposAlServidor(updates).then(resultado => {
        if (resultado.success) {
            console.log('✅ Grupos limpiados en servidor');
        }
    }).catch(error => {
        console.error('❌ Error limpiando grupos en servidor:', error);
    });
    
    if (typeof limpiarBurbujasAnteriores === 'function') {
        limpiarBurbujasAnteriores();
        console.log('✅ Burbujas limpiadas');
    }
    
    mostrarNotificacion('info', 'Grupos de demostración eliminados');
    console.log('✅ Grupos demo eliminados de', updates.length, 'nodos');
};

// Función mejorada para mostrar notificación
function mostrarNotificacion(tipo, mensaje, duracion = 5000) {
    // Crear contenedor de notificaciones si no existe
    let container = document.getElementById('notifications-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notifications-container';
        container.className = 'notifications-container';
        document.body.appendChild(container);
    }
    
    // Crear notificación
    const notificacion = document.createElement('div');
    notificacion.className = `notification notification-${tipo}`;
    
    const iconos = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    
    notificacion.innerHTML = `
        <span class="notification-icon">${iconos[tipo] || 'ℹ️'}</span>
        <span class="notification-message">${mensaje}</span>
        <button class="notification-close" onclick="this.parentElement.remove()">×</button>
    `;
    
    container.appendChild(notificacion);
    
    // Mostrar notificación
    setTimeout(() => {
        notificacion.classList.add('notification-show');
    }, 100);
    
    // Auto-eliminar después de la duración especificada
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.classList.remove('notification-show');
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 300);
        }
    }, duracion);
}

// Función de debug global para probar todo el sistema
window.debugSistemaCompleto = function() {
    console.log('🔍 DEBUG DEL SISTEMA COMPLETO CON PERSISTENCIA:');
    console.log('===============================================');
    
    // Verificar componentes principales
    console.log('📊 Red principal:', typeof network !== 'undefined' && network ? '✅ Disponible' : '❌ No disponible');
    console.log('👥 Nodos:', typeof nodes !== 'undefined' && nodes ? `✅ Disponible (${nodes.length} nodos)` : '❌ No disponible');
    console.log('🔗 Aristas:', typeof edges !== 'undefined' && edges ? `✅ Disponible (${edges.length} aristas)` : '❌ No disponible');
    
    // Verificar sistemas adicionales
    console.log('🎯 Creación nodos:', typeof configurarDobleClickCrearNodo === 'function' ? '✅ Disponible' : '❌ No disponible');
    console.log('🔗 Creación aristas:', typeof configurarHoverCrearAristas === 'function' ? '✅ Disponible' : '❌ No disponible');
    console.log('🫧 Sistema burbujas:', typeof crearBurbujasGrupos === 'function' ? '✅ Disponible' : '❌ No disponible');
    console.log('📋 Gestión grupos:', typeof abrirModalGestionGrupos === 'function' ? '✅ Disponible' : '❌ No disponible');
    
    // Verificar persistencia
    console.log('💾 Persistencia grupos:', typeof enviarActualizacionesGruposAlServidor === 'function' ? '✅ Disponible' : '❌ No disponible');
    console.log('📥 Obtener grupos:', typeof obtenerGruposDelServidor === 'function' ? '✅ Disponible' : '❌ No disponible');
    console.log('🔄 Sincronización:', typeof sincronizarGruposAlCargar === 'function' ? '✅ Disponible' : '❌ No disponible');
    
    // Estado de burbujas
    if (typeof burbujasActivas !== 'undefined') {
        console.log('🫧 Burbujas activas:', burbujasActivas ? '✅ Activadas' : '❌ Desactivadas');
        console.log('🎨 Opacidad burbujas:', typeof opacidadBurbujas !== 'undefined' ? opacidadBurbujas : 'N/A');
    } else {
        console.log('🫧 Estado burbujas: No disponible');
    }
    
    // Estadísticas de grupos (SIN RECURSIÓN)
    try {
        if (typeof obtenerEstadisticasGrupos === 'function') {
            const stats = obtenerEstadisticasGrupos();
            console.log('📊 Estadísticas grupos disponibles:', Object.keys(stats).length, 'grupos');
            console.table(stats);
        } else {
            console.log('📊 Estadísticas grupos: No disponible aún');
        }
    } catch (error) {
        console.log('📊 Estadísticas grupos: Error -', error.message);
    }
    
    // Bootstrap
    console.log('🅱️ Bootstrap:', typeof bootstrap !== 'undefined' ? '✅ Disponible' : '❌ No disponible');
    
    console.log('===============================================');
    console.log('💡 Funciones de prueba disponibles:');
    console.log('- crearGruposDemo() - Crear grupos de demostración (CON PERSISTENCIA)');
    console.log('- limpiarGruposDemo() - Limpiar grupos demo (CON PERSISTENCIA)');
    console.log('- verificarSincronizacionGrupos() - Verificar sincronización con servidor');
    console.log('- diagnosticarProblemasPersistencia() - Diagnosticar problemas');
    console.log('- mostrarEstadisticasGruposModal() - Ver estadísticas en modal');
    console.log('===============================================');
};

// Mostrar mensaje de bienvenida cuando todo esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 DOM cargado, esperando sistemas con persistencia...');
    
    setTimeout(function() {
        // Verificar si todo está cargado
        const sistemaCompleto = (
            typeof network !== 'undefined' && network &&
            typeof crearBurbujasGrupos === 'function' &&
            typeof abrirModalGestionGrupos === 'function' &&
            typeof enviarActualizacionesGruposAlServidor === 'function'
        );
        
        if (sistemaCompleto) {
            console.log('🎉 ¡Sistema completo de red social con grupos Y PERSISTENCIA cargado exitosamente!');
            console.log('💾 Los grupos ahora se guardan automáticamente en el servidor');
            console.log('🔄 Al recargar la página, los grupos se mantienen');
            console.log('💡 Ejecuta debugSistemaCompleto() para ver el estado completo');
            console.log('🧪 Ejecuta crearGruposDemo() para ver una demostración de grupos PERSISTENTES');
            console.log('🔍 Ejecuta diagnosticarProblemasPersistencia() para verificar el sistema');
            console.log('✨ ¡Todo listo para usar con persistencia completa!');
            
            // Sincronizar grupos automáticamente al cargar
            setTimeout(async () => {
                try {
                    await sincronizarGruposAlCargar();
                    console.log('🔄 Sincronización automática completada');
                } catch (error) {
                    console.warn('⚠️ Error en sincronización automática:', error);
                }
            }, 1000);
            
        } else {
            console.log('⏳ Sistema aún cargando... ejecuta debugSistemaCompleto() para ver el estado');
        }
    }, 3000);
});

console.log('✅ Scripts de integración con persistencia cargados correctamente');
</script>
{% endblock %}