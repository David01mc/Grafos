<!-- Incluir la correcci√≥n espec√≠fica para aria-hidden -->
<script src="{{ url_for('static', filename='js/aria-hidden-fix.js') }}"></script>

<!-- Script para debugging de burbujas -->
<script>
// Script para debuggear y activar las burbujas

// Funci√≥n para verificar el estado completo del sistema de burbujas
window.verificarSistemaBurbujas = function() {
    console.log('üîç DIAGN√ìSTICO COMPLETO DEL SISTEMA DE BURBUJAS:');
    console.log('='.repeat(50));
    
    // 1. Verificar dependencias b√°sicas
    console.log('üìã DEPENDENCIAS:');
    console.log('- Network:', typeof network !== 'undefined' ? '‚úÖ' : '‚ùå');
    console.log('- Nodes:', typeof nodes !== 'undefined' ? '‚úÖ' : '‚ùå');
    console.log('- Edges:', typeof edges !== 'undefined' ? '‚úÖ' : '‚ùå');
    
    // 2. Verificar funciones del sistema de burbujas
    console.log('\nü´ß FUNCIONES DE BURBUJAS:');
    console.log('- crearBurbujasGrupos:', typeof crearBurbujasGrupos === 'function' ? '‚úÖ' : '‚ùå');
    console.log('- toggleBurbujas:', typeof toggleBurbujas === 'function' ? '‚úÖ' : '‚ùå');
    console.log('- obtenerEstadisticasGrupos:', typeof obtenerEstadisticasGrupos === 'function' ? '‚úÖ' : '‚ùå');
    console.log('- limpiarBurbujasAnteriores:', typeof limpiarBurbujasAnteriores === 'function' ? '‚úÖ' : '‚ùå');
    
    // 3. Verificar estado de las burbujas
    console.log('\nüéõÔ∏è ESTADO ACTUAL:');
    console.log('- burbujasActivas:', typeof burbujasActivas !== 'undefined' ? burbujasActivas : 'No definido');
    console.log('- opacidadBurbujas:', typeof opacidadBurbujas !== 'undefined' ? opacidadBurbujas : 'No definido');
    
    // 4. Verificar nodos y grupos
    if (typeof nodes !== 'undefined' && nodes) {
        const todosLosNodos = nodes.get();
        console.log('\nüë• NODOS Y GRUPOS:');
        console.log('- Total nodos:', todosLosNodos.length);
        
        const gruposEncontrados = {};
        todosLosNodos.forEach(nodo => {
            const grupo = nodo.grupo || 'sin_grupo';
            gruposEncontrados[grupo] = (gruposEncontrados[grupo] || 0) + 1;
        });
        
        console.log('- Distribuci√≥n por grupos:');
        Object.entries(gruposEncontrados).forEach(([grupo, cantidad]) => {
            console.log(`  ${grupo}: ${cantidad} nodos`);
        });
    }
    
    // 5. Verificar elementos SVG de burbujas
    console.log('\nüñºÔ∏è ELEMENTOS VISUALES:');
    const svgBurbujas = document.querySelector('.burbujas-svg');
    console.log('- SVG de burbujas:', svgBurbujas ? '‚úÖ Presente' : '‚ùå No encontrado');
    
    if (svgBurbujas) {
        const burbujas = svgBurbujas.querySelectorAll('.burbuja-grupo');
        const etiquetas = svgBurbujas.querySelectorAll('.etiqueta-grupo');
        console.log('- Burbujas encontradas:', burbujas.length);
        console.log('- Etiquetas encontradas:', etiquetas.length);
        
        burbujas.forEach((burbuja, index) => {
            const grupo = burbuja.getAttribute('data-grupo');
            console.log(`  Burbuja ${index + 1}: ${grupo || 'sin nombre'}`);
        });
    }
    
    console.log('='.repeat(50));
    console.log('üí° ACCIONES SUGERIDAS:');
    console.log('- activarBurbujasManualmente() - Forzar activaci√≥n');
    console.log('- crearGruposDemo() - Crear grupos de prueba');
    console.log('- repararSistemaBurbujas() - Intentar reparaci√≥n autom√°tica');
};

// Funci√≥n para activar burbujas manualmente
window.activarBurbujasManualmente = function() {
    console.log('üîÑ Activando burbujas manualmente...');
    
    if (typeof nodes === 'undefined' || !nodes) {
        console.error('‚ùå Nodes no disponible');
        return;
    }
    
    if (typeof network === 'undefined' || !network) {
        console.error('‚ùå Network no disponible');
        return;
    }
    
    // Activar burbujas
    if (typeof burbujasActivas !== 'undefined') {
        window.burbujasActivas = true;
    }
    
    // Crear burbujas
    if (typeof crearBurbujasGrupos === 'function') {
        try {
            crearBurbujasGrupos();
            console.log('‚úÖ Burbujas creadas exitosamente');
        } catch (error) {
            console.error('‚ùå Error creando burbujas:', error);
        }
    } else {
        console.error('‚ùå Funci√≥n crearBurbujasGrupos no disponible');
    }
    
    // Verificar resultado
    setTimeout(() => {
        const svgBurbujas = document.querySelector('.burbujas-svg');
        if (svgBurbujas) {
            const burbujas = svgBurbujas.querySelectorAll('.burbuja-grupo');
            console.log(`‚úÖ ${burbujas.length} burbujas creadas`);
        } else {
            console.warn('‚ö†Ô∏è No se encontraron burbujas despu√©s de la activaci√≥n');
        }
    }, 500);
};

// Funci√≥n para reparar el sistema de burbujas
window.repararSistemaBurbujas = function() {
    console.log('üîß Reparando sistema de burbujas...');
    
    // 1. Limpiar burbujas existentes
    if (typeof limpiarBurbujasAnteriores === 'function') {
        limpiarBurbujasAnteriores();
        console.log('üßπ Burbujas anteriores limpiadas');
    }
    
    // 2. Verificar que tenemos grupos
    if (typeof nodes !== 'undefined' && nodes) {
        const todosLosNodos = nodes.get();
        const tienenGrupos = todosLosNodos.some(nodo => nodo.grupo && nodo.grupo !== 'sin_grupo');
        
        if (!tienenGrupos) {
            console.log('üìã No hay grupos asignados, creando grupos demo...');
            if (typeof crearGruposDemo === 'function') {
                crearGruposDemo();
            }
        }
    }
    
    // 3. Esperar un momento y activar burbujas
    setTimeout(() => {
        activarBurbujasManualmente();
    }, 1000);
    
    console.log('üîß Reparaci√≥n completada');
};

// Funci√≥n para diagn√≥stico r√°pido
window.diagnosticoBurbujas = function() {
    console.log('‚ö° DIAGN√ìSTICO R√ÅPIDO:');
    
    const problemas = [];
    
    if (typeof network === 'undefined') problemas.push('‚ùå Network no definido');
    if (typeof nodes === 'undefined') problemas.push('‚ùå Nodes no definido');
    if (typeof crearBurbujasGrupos !== 'function') problemas.push('‚ùå crearBurbujasGrupos no es funci√≥n');
    
    const container = document.getElementById('network');
    if (!container) problemas.push('‚ùå Contenedor #network no encontrado');
    
    const svg = document.querySelector('.burbujas-svg');
    if (!svg) problemas.push('‚ö†Ô∏è SVG de burbujas no existe');
    
    if (problemas.length === 0) {
        console.log('‚úÖ No se encontraron problemas obvios');
        console.log('üí° Intenta: activarBurbujasManualmente()');
    } else {
        console.log('üö® Problemas encontrados:');
        problemas.forEach(problema => console.log(problema));
    }
};

console.log('üõ†Ô∏è Herramientas de debugging de burbujas cargadas');
console.log('üí° Ejecuta: verificarSistemaBurbujas() para diagnosticar');

// Script para arreglar los grupos y activar burbujas
window.reorganizarGruposParaBurbujas = function() {
    console.log('üîÑ Reorganizando nodos en grupos con m√∫ltiples miembros...');
    
    if (!nodes) {
        console.error('‚ùå Nodes no disponible');
        return;
    }
    
    const todosLosNodos = nodes.get();
    console.log('üìä Total nodos disponibles:', todosLosNodos.length);
    
    // Crear grupos con m√∫ltiples nodos para que aparezcan las burbujas
    const updates = [];
    
    todosLosNodos.forEach((nodo, index) => {
        let nuevoGrupo = null;
        
        // Distribuir nodos en 4 grupos principales con m√∫ltiples miembros cada uno
        if (index % 4 === 0) {
            nuevoGrupo = 'universidad';
        } else if (index % 4 === 1) {
            nuevoGrupo = 'trabajo';
        } else if (index % 4 === 2) {
            nuevoGrupo = 'familia_cercana';
        } else {
            nuevoGrupo = 'amigos';
        }
        
        updates.push({
            id: nodo.id,
            grupo: nuevoGrupo
        });
        
        console.log(`üìù Nodo ${nodo.id} (${nodo.label?.replace(/<[^>]*>/g, '') || 'Sin nombre'}) ‚Üí Grupo: ${nuevoGrupo}`);
    });
    
    // Aplicar los cambios
    nodes.update(updates);
    console.log('‚úÖ Grupos reorganizados exitosamente');
    
    // Verificar la nueva distribuci√≥n
    const nuevaDistribucion = {};
    updates.forEach(update => {
        nuevaDistribucion[update.grupo] = (nuevaDistribucion[update.grupo] || 0) + 1;
    });
    
    console.log('üìà Nueva distribuci√≥n de grupos:');
    Object.entries(nuevaDistribucion).forEach(([grupo, cantidad]) => {
        console.log(`  ${grupo}: ${cantidad} nodos`);
    });
    
    // Ahora crear las burbujas
    setTimeout(() => {
        if (typeof crearBurbujasGrupos === 'function') {
            crearBurbujasGrupos();
            console.log('ü´ß Burbujas creadas con la nueva distribuci√≥n');
            
            // Verificar que se crearon
            setTimeout(() => {
                const svgBurbujas = document.querySelector('.burbujas-svg');
                if (svgBurbujas) {
                    const burbujas = svgBurbujas.querySelectorAll('.burbuja-grupo');
                    console.log(`üéâ ¬°${burbujas.length} burbujas creadas exitosamente!`);
                    
                    if (burbujas.length > 0) {
                        mostrarNotificacion('success', `¬°${burbujas.length} burbujas de grupos creadas! Ahora puedes ver los grupos de personas.`);
                    }
                } else {
                    console.warn('‚ö†Ô∏è SVG no encontrado despu√©s de crear burbujas');
                }
            }, 500);
        }
    }, 500);
    
    return nuevaDistribucion;
};

// Funci√≥n alternativa para crear burbujas incluso con un solo nodo
window.forzarBurbujasParaTodos = function() {
    console.log('üí™ Forzando creaci√≥n de burbujas para todos los grupos...');
    
    if (!nodes || !network) {
        console.error('‚ùå Dependencias no disponibles');
        return;
    }
    
    const container = document.getElementById('network');
    if (!container) {
        console.error('‚ùå Contenedor network no encontrado');
        return;
    }
    
    // Limpiar burbujas existentes
    if (typeof limpiarBurbujasAnteriores === 'function') {
        limpiarBurbujasAnteriores();
    }
    
    // Agrupar nodos
    const nodosPorGrupo = {};
    const todosLosNodos = nodes.get();
    
    todosLosNodos.forEach(nodo => {
        const grupo = nodo.grupo || 'sin_grupo';
        if (grupo !== 'sin_grupo') {
            if (!nodosPorGrupo[grupo]) {
                nodosPorGrupo[grupo] = [];
            }
            nodosPorGrupo[grupo].push(nodo);
        }
    });
    
    console.log('üìã Grupos encontrados:', Object.keys(nodosPorGrupo));
    
    // Crear SVG
    let svg = container.querySelector('.burbujas-svg');
    if (!svg) {
        svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.classList.add('burbujas-svg');
        svg.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: visible;
        `;
        container.appendChild(svg);
    }
    
    // Crear burbujas para TODOS los grupos (incluso con 1 nodo)
    let burbujasCreadas = 0;
    Object.entries(nodosPorGrupo).forEach(([grupo, nodosGrupo], index) => {
        if (nodosGrupo.length > 0) { // Cambi√© de > 1 a > 0
            // Obtener posiciones de los nodos
            const posicionesNodos = network.getPositions();
            let posiciones = [];
            
            nodosGrupo.forEach(nodo => {
                const pos = posicionesNodos[nodo.id];
                if (pos) {
                    const posDOM = network.canvasToDOM(pos);
                    posiciones.push(posDOM);
                }
            });
            
            if (posiciones.length === 1) {
                // Para un solo nodo, crear un c√≠rculo alrededor
                const pos = posiciones[0];
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', pos.x);
                circle.setAttribute('cy', pos.y);
                circle.setAttribute('r', 40);
                circle.setAttribute('fill', `hsl(${index * 50}, 70%, 80%)`);
                circle.setAttribute('fill-opacity', '0.2');
                circle.setAttribute('stroke', `hsl(${index * 50}, 70%, 50%)`);
                circle.setAttribute('stroke-width', '2');
                circle.setAttribute('stroke-dasharray', '5,5');
                circle.classList.add('burbuja-grupo');
                circle.setAttribute('data-grupo', grupo);
                
                svg.appendChild(circle);
                
                // Etiqueta
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', pos.x);
                text.setAttribute('y', pos.y - 50);
                text.setAttribute('text-anchor', 'middle');
                text.style.cssText = `
                    font-family: var(--font-primary);
                    font-size: 12px;
                    font-weight: 600;
                    fill: hsl(${index * 50}, 70%, 30%);
                `;
                text.textContent = grupo.replace(/_/g, ' ').toUpperCase();
                text.classList.add('etiqueta-grupo');
                
                svg.appendChild(text);
                burbujasCreadas++;
                
            } else if (posiciones.length > 1) {
                // Para m√∫ltiples nodos, usar algoritmo normal
                const minX = Math.min(...posiciones.map(p => p.x)) - 30;
                const maxX = Math.max(...posiciones.map(p => p.x)) + 30;
                const minY = Math.min(...posiciones.map(p => p.y)) - 30;
                const maxY = Math.max(...posiciones.map(p => p.y)) + 30;
                
                const width = maxX - minX;
                const height = maxY - minY;
                const centerX = minX + width / 2;
                const centerY = minY + height / 2;
                
                // Crear elipse
                const ellipse = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
                ellipse.setAttribute('cx', centerX);
                ellipse.setAttribute('cy', centerY);
                ellipse.setAttribute('rx', Math.max(width / 2, 40));
                ellipse.setAttribute('ry', Math.max(height / 2, 30));
                ellipse.setAttribute('fill', `hsl(${index * 50}, 70%, 80%)`);
                ellipse.setAttribute('fill-opacity', '0.2');
                ellipse.setAttribute('stroke', `hsl(${index * 50}, 70%, 50%)`);
                ellipse.setAttribute('stroke-width', '2');
                ellipse.setAttribute('stroke-dasharray', '5,5');
                ellipse.classList.add('burbuja-grupo');
                ellipse.setAttribute('data-grupo', grupo);
                
                svg.appendChild(ellipse);
                
                // Etiqueta
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', centerX);
                text.setAttribute('y', centerY - Math.max(height / 2, 30) - 10);
                text.setAttribute('text-anchor', 'middle');
                text.style.cssText = `
                    font-family: var(--font-primary);
                    font-size: 12px;
                    font-weight: 600;
                    fill: hsl(${index * 50}, 70%, 30%);
                `;
                text.textContent = grupo.replace(/_/g, ' ').toUpperCase();
                text.classList.add('etiqueta-grupo');
                
                svg.appendChild(text);
                burbujasCreadas++;
            }
            
            console.log(`‚úÖ Burbuja creada para grupo: ${grupo} (${nodosGrupo.length} nodos)`);
        }
    });
    
    console.log(`üéâ ${burbujasCreadas} burbujas forzadas creadas exitosamente`);
    
    if (burbujasCreadas > 0) {
        mostrarNotificacion('success', `¬°${burbujasCreadas} burbujas creadas! Cada grupo ahora tiene su burbuja visual.`);
    }
    
    return burbujasCreadas;
};

console.log('üõ†Ô∏è Scripts de reparaci√≥n de burbujas cargados');
console.log('üí° SOLUCI√ìN PARA TUS BURBUJAS:');
console.log('- reorganizarGruposParaBurbujas() - Redistribuir en 4 grupos principales');
console.log('- forzarBurbujasParaTodos() - Crear burbujas incluso para grupos de 1 nodo');
</script><!-- templates/index.html -->
{% extends "base.html" %}

{% block title %}An√°lisis de Red de Relaciones{% endblock %}

{% block content %}
<div class="main-container main-container-fullscreen">
    
    <!-- Estad√≠sticas principales -->
    <div class="row mb-2 stats-row">
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="total-personas">0</h4>
                <p class="mb-0">
                    <i class="icon icon-users icon-white"></i>
                    Contactos
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="total-conexiones">0</h4>
                <p class="mb-0">
                    <i class="icon icon-connections icon-white"></i>
                    Conexiones
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="densidad-red">0%</h4>
                <p class="mb-0">
                    <i class="icon icon-chart icon-white"></i>
                    Densidad
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h5 id="mas-conectado" class="nombre-conectado">Cargando...</h5>
                <p class="mb-0">
                    <i class="icon icon-crown icon-white"></i>
                    M√°s Conectado
                </p>
            </div>
        </div>
    </div>    

    <!-- Contenedor del grafo -->
    <div class="row network-row">
        <div class="col-12 network-col">
            <div class="admin-panel admin-panel-compact">

                <!-- Controles principales -->
                <div class="controls-container">
                    <!-- Fila 1: Controles b√°sicos del grafo -->
                    <div class="controls-row mb-2">
                        <button class="btn btn-success btn-custom btn-sm me-2" onclick="centrarRed()">
                            <i class="icon icon-target icon-sm"></i>
                            Centrar Vista
                        </button>
                        <button class="btn btn-info btn-custom btn-sm me-2" onclick="togglePhysics()">
                            <i class="icon icon-lightning icon-sm"></i>
                            Activar F√≠sica
                        </button>
                        <button class="btn btn-warning btn-custom btn-sm me-2" onclick="randomizePositions()">
                            <i class="icon icon-shuffle icon-sm"></i>
                            Reorganizar
                        </button>
                        <button class="btn btn-primary btn-custom btn-sm" onclick="recargarDatos()">
                            <i class="icon icon-refresh icon-sm"></i>
                            Recargar
                        </button>
                    </div>
                    
                    <!-- Fila 2: Controles de grupos y burbujas -->
                    <div class="controls-row">
                        <button class="btn btn-outline-primary btn-custom btn-sm me-2" onclick="toggleBurbujas()">
                            <i class="icon icon-chart icon-sm"></i>
                            Mostrar Grupos
                        </button>
                        <button class="btn btn-outline-success btn-custom btn-sm me-2" onclick="abrirModalGestionGrupos()">
                            <i class="icon icon-settings icon-sm"></i>
                            Gestionar Grupos
                        </button>
                        <button class="btn btn-outline-info btn-custom btn-sm me-2" onclick="mostrarPanelControlBurbujas()">
                            <i class="icon icon-users icon-sm"></i>
                            Control Burbujas
                        </button>
                        <button class="btn btn-outline-secondary btn-custom btn-sm" onclick="mostrarEstadisticasGruposModal()">
                            <i class="icon icon-chart icon-sm"></i>
                            Stats Grupos
                        </button>
                    </div>
                </div>
                
                <!-- Instrucciones de uso -->
                <div class="alert alert-info mb-3" style="font-size: 0.8rem; padding: 0.5rem;">
                    <div class="row">
                        <div class="col-md-6">
                            <i class="icon icon-plus icon-sm"></i>
                            <strong>Crear Personas:</strong> Haz <strong>doble clic</strong> en cualquier √°rea vac√≠a del grafo para crear una nueva persona.
                        </div>
                        <div class="col-md-6">
                            <i class="icon icon-link icon-sm"></i>
                            <strong>Crear Relaciones:</strong> Pasa el cursor sobre una persona y haz clic en el bot√≥n <strong>+</strong> que aparece.
                        </div>
                    </div>
                    <div class="row mt-1">
                        <div class="col-md-6">
                            <i class="icon icon-chart icon-sm"></i>
                            <strong>Grupos:</strong> Usa <strong>"Gestionar Grupos"</strong> para crear burbujas que agrupen personas por universidad, ciudad, etc.
                        </div>
                        <div class="col-md-6">
                            <i class="icon icon-users icon-sm"></i>
                            <strong>Burbujas:</strong> Las burbujas de colores muestran grupos como "Universidad", "C√°diz", "Trabajo", etc.
                        </div>
                    </div>
                </div>
                
                <!-- El grafo -->
                <div id="network" class="network-container network-full-height"></div>
                
            </div>
        </div>
    </div>
    
</div>

<!-- Sistema de notificaciones pop-up -->
<div id="notifications-container" class="notifications-container"></div>

{% endblock %}

{% block scripts %}
<!-- Incluir el archivo JavaScript principal -->
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<!-- Incluir el nuevo archivo JavaScript para creaci√≥n de nodos -->
<script src="{{ url_for('static', filename='js/create-node.js') }}"></script>
<!-- Incluir el nuevo archivo JavaScript para creaci√≥n de aristas -->
<script src="{{ url_for('static', filename='js/create-edge.js') }}"></script>
<!-- Incluir el sistema de burbujas de grupos -->
<script src="{{ url_for('static', filename='js/group-bubbles.js') }}"></script>
<!-- Incluir el sistema de gesti√≥n de grupos -->
<script src="{{ url_for('static', filename='js/group-management.js') }}"></script>
<!-- Incluir las correcciones de accesibilidad -->
<script src="{{ url_for('static', filename='js/accessibility-fixes.js') }}"></script>
<!-- Incluir la correcci√≥n espec√≠fica para aria-hidden -->
<script src="{{ url_for('static', filename='js/aria-hidden-fix.js') }}"></script>

<!-- Script CORREGIDO para integraci√≥n - SIN RECURSI√ìN -->
<script>
console.log('üöÄ Iniciando scripts de integraci√≥n...');

// Funci√≥n CORREGIDA para mostrar estad√≠sticas de grupos - SIN RECURSI√ìN
window.mostrarEstadisticasGruposModal = function() {
    console.log('üìä Abriendo modal de estad√≠sticas de grupos...');
    
    // Verificar que los sistemas est√©n disponibles
    if (typeof obtenerEstadisticasGrupos !== 'function') {
        console.warn('‚ö†Ô∏è Funci√≥n obtenerEstadisticasGrupos no disponible');
        mostrarNotificacion('warning', 'Sistema de estad√≠sticas no disponible a√∫n. Intenta en unos segundos.');
        return;
    }
    
    try {
        // Llamar a la funci√≥n SIN recursi√≥n - usando la funci√≥n global
        const stats = obtenerEstadisticasGrupos();
        console.log('üìä Estad√≠sticas obtenidas:', stats);
        console.table(stats);
        
        // Crear modal para mostrar estad√≠sticas
        let html = `
            <div class="modal fade" id="modalEstadisticasGrupos" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="icon icon-chart"></i>
                                Estad√≠sticas de Grupos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Grupo</th>
                                            <th>Nodos</th>
                                            <th>Conexiones Internas</th>
                                            <th>Conexiones Externas</th>
                                            <th>Densidad Interna</th>
                                            <th>Color</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        if (Object.keys(stats).length === 0) {
            html += '<tr><td colspan="6" class="text-center text-muted">No hay grupos con datos suficientes</td></tr>';
        } else {
            Object.entries(stats).forEach(([grupo, data]) => {
                const nombreFormateado = typeof formatearNombreGrupo === 'function' ? formatearNombreGrupo(grupo) : grupo;
                html += `
                    <tr>
                        <td><strong>${nombreFormateado}</strong></td>
                        <td><span class="badge bg-primary">${data.nodos}</span></td>
                        <td><span class="badge bg-success">${data.conexionesInternas}</span></td>
                        <td><span class="badge bg-info">${data.conexionesExternas}</span></td>
                        <td><span class="badge bg-warning">${data.densidad}</span></td>
                        <td>
                            <div style="width: 20px; height: 20px; background: ${data.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        </td>
                    </tr>
                `;
            });
        }
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <h6><i class="icon icon-chart"></i> Explicaci√≥n:</h6>
                                <ul class="mb-0">
                                    <li><strong>Nodos:</strong> Cantidad de personas en el grupo</li>
                                    <li><strong>Conexiones Internas:</strong> Relaciones entre miembros del mismo grupo</li>
                                    <li><strong>Conexiones Externas:</strong> Relaciones con personas de otros grupos</li>
                                    <li><strong>Densidad Interna:</strong> Porcentaje de conexiones internas respecto al m√°ximo posible</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="if(typeof crearBurbujasGrupos === 'function') crearBurbujasGrupos()">
                                <i class="icon icon-refresh"></i> Actualizar Burbujas
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Limpiar modal anterior
        const modalAnterior = document.getElementById('modalEstadisticasGrupos');
        if (modalAnterior) {
            modalAnterior.remove();
        }
        
        // Agregar y mostrar nuevo modal
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('modalEstadisticasGrupos'));
        modal.show();
        
        console.log('‚úÖ Modal de estad√≠sticas mostrado correctamente');
        
    } catch (error) {
        console.error('‚ùå Error obteniendo estad√≠sticas:', error);
        mostrarNotificacion('error', 'Error al obtener estad√≠sticas de grupos: ' + error.message);
    }
};

// Funci√≥n para demostraci√≥n de grupos
window.crearGruposDemo = function() {
    console.log('üß™ Creando grupos de demostraci√≥n...');
    
    if (!nodes) {
        console.error('‚ùå Nodes no disponible');
        mostrarNotificacion('error', 'Sistema de nodos no disponible');
        return;
    }
    
    // Obtener todos los nodos
    const todosLosNodos = nodes.get();
    
    if (todosLosNodos.length < 4) {
        console.log('‚ö†Ô∏è Se necesitan al menos 4 nodos para la demo');
        mostrarNotificacion('info', 'Agrega m√°s personas para ver una mejor demostraci√≥n de grupos');
        return;
    }
    
    // Asignar grupos de ejemplo
    const updates = [];
    
    todosLosNodos.forEach((nodo, index) => {
        let grupo = null;
        
        // Distribuir nodos en grupos de ejemplo
        if (index % 4 === 0) {
            grupo = 'universidad';
        } else if (index % 4 === 1) {
            grupo = 'trabajo';
        } else if (index % 4 === 2) {
            grupo = 'cadiz';
        } else {
            grupo = 'amigos';
        }
        
        updates.push({
            id: nodo.id,
            grupo: grupo
        });
    });
    
    // Aplicar cambios
    nodes.update(updates);
    
    // Crear burbujas
    setTimeout(() => {
        if (typeof crearBurbujasGrupos === 'function') {
            crearBurbujasGrupos();
            console.log('‚úÖ Burbujas de grupos creadas');
        }
    }, 500);
    
    mostrarNotificacion('success', '¬°Grupos de demostraci√≥n creados! Ahora puedes ver las burbujas de colores.');
    console.log('‚úÖ Grupos demo aplicados a', updates.length, 'nodos');
};

// Funci√≥n para limpiar grupos demo
window.limpiarGruposDemo = function() {
    console.log('üßπ Limpiando grupos de demostraci√≥n...');
    
    if (!nodes) {
        console.error('‚ùå Nodes no disponible');
        return;
    }
    
    const todosLosNodos = nodes.get();
    const updates = todosLosNodos.map(nodo => ({
        id: nodo.id,
        grupo: null
    }));
    
    nodes.update(updates);
    
    if (typeof limpiarBurbujasAnteriores === 'function') {
        limpiarBurbujasAnteriores();
        console.log('‚úÖ Burbujas limpiadas');
    }
    
    mostrarNotificacion('info', 'Grupos de demostraci√≥n eliminados');
    console.log('‚úÖ Grupos demo eliminados de', updates.length, 'nodos');
};

// Funci√≥n mejorada para mostrar notificaci√≥n
function mostrarNotificacion(tipo, mensaje, duracion = 5000) {
    // Crear contenedor de notificaciones si no existe
    let container = document.getElementById('notifications-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notifications-container';
        container.className = 'notifications-container';
        document.body.appendChild(container);
    }
    
    // Crear notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `notification notification-${tipo}`;
    
    const iconos = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    
    notificacion.innerHTML = `
        <span class="notification-icon">${iconos[tipo] || '‚ÑπÔ∏è'}</span>
        <span class="notification-message">${mensaje}</span>
        <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    container.appendChild(notificacion);
    
    // Mostrar notificaci√≥n
    setTimeout(() => {
        notificacion.classList.add('notification-show');
    }, 100);
    
    // Auto-eliminar despu√©s de la duraci√≥n especificada
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.classList.remove('notification-show');
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 300);
        }
    }, duracion);
}

// Funci√≥n de debug global para probar todo el sistema
window.debugSistemaCompleto = function() {
    console.log('üîç DEBUG DEL SISTEMA COMPLETO:');
    console.log('================================');
    
    // Verificar componentes principales
    console.log('üìä Red principal:', typeof network !== 'undefined' && network ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('üë• Nodos:', typeof nodes !== 'undefined' && nodes ? `‚úÖ Disponible (${nodes.length} nodos)` : '‚ùå No disponible');
    console.log('üîó Aristas:', typeof edges !== 'undefined' && edges ? `‚úÖ Disponible (${edges.length} aristas)` : '‚ùå No disponible');
    
    // Verificar sistemas adicionales
    console.log('üéØ Creaci√≥n nodos:', typeof configurarDobleClickCrearNodo === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('üîó Creaci√≥n aristas:', typeof configurarHoverCrearAristas === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('ü´ß Sistema burbujas:', typeof crearBurbujasGrupos === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('üìã Gesti√≥n grupos:', typeof abrirModalGestionGrupos === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    
    // Estado de burbujas
    if (typeof burbujasActivas !== 'undefined') {
        console.log('ü´ß Burbujas activas:', burbujasActivas ? '‚úÖ Activadas' : '‚ùå Desactivadas');
        console.log('üé® Opacidad burbujas:', typeof opacidadBurbujas !== 'undefined' ? opacidadBurbujas : 'N/A');
    } else {
        console.log('ü´ß Estado burbujas: No disponible');
    }
    
    // Estad√≠sticas de grupos (SIN RECURSI√ìN)
    try {
        if (typeof obtenerEstadisticasGrupos === 'function') {
            const stats = obtenerEstadisticasGrupos();
            console.log('üìä Estad√≠sticas grupos disponibles:', Object.keys(stats).length, 'grupos');
            console.table(stats);
        } else {
            console.log('üìä Estad√≠sticas grupos: No disponible a√∫n');
        }
    } catch (error) {
        console.log('üìä Estad√≠sticas grupos: Error -', error.message);
    }
    
    // Bootstrap
    console.log('üÖ±Ô∏è Bootstrap:', typeof bootstrap !== 'undefined' ? '‚úÖ Disponible' : '‚ùå No disponible');
    
    console.log('================================');
    console.log('üí° Funciones de prueba disponibles:');
    console.log('- crearGruposDemo() - Crear grupos de demostraci√≥n');
    console.log('- limpiarGruposDemo() - Limpiar grupos demo');
    console.log('- mostrarEstadisticasGruposModal() - Ver estad√≠sticas en modal');
    console.log('- testBurbujas() - Probar sistema de burbujas (si est√° disponible)');
    console.log('- testModalRelacion() - Probar modal de relaciones (si est√° disponible)');
    console.log('- verificarNodos() - Ver todos los nodos disponibles (si est√° disponible)');
    console.log('================================');
};

// Mostrar mensaje de bienvenida cuando todo est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM cargado, esperando sistemas...');
    
    setTimeout(function() {
        // Verificar si todo est√° cargado
        const sistemaCompleto = (
            typeof network !== 'undefined' && network &&
            typeof crearBurbujasGrupos === 'function' &&
            typeof abrirModalGestionGrupos === 'function'
        );
        
        if (sistemaCompleto) {
            console.log('üéâ ¬°Sistema completo de red social con grupos cargado exitosamente!');
            console.log('üí° Ejecuta debugSistemaCompleto() para ver el estado completo');
            console.log('üß™ Ejecuta crearGruposDemo() para ver una demostraci√≥n de grupos');
            console.log('üìä Ejecuta mostrarEstadisticasGruposModal() para ver estad√≠sticas');
            console.log('‚ú® ¬°Todo listo para usar!');
        } else {
            console.log('‚è≥ Sistema a√∫n cargando... ejecuta debugSistemaCompleto() para ver el estado');
        }
    }, 3000);
});

console.log('‚úÖ Scripts de integraci√≥n cargados correctamente');
</script>
{% endblock %}