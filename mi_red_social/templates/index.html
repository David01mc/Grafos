<!-- templates/index.html - VERSI√ìN CORREGIDA CON PERSISTENCIA -->
{% extends "base.html" %}

{% block title %}An√°lisis de Red de Relaciones{% endblock %}

{% block content %}
<div class="main-container main-container-fullscreen">
    
    <!-- Estad√≠sticas principales -->
    <div class="row mb-2 stats-row">
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="total-personas">0</h4>
                <p class="mb-0">
                    <i class="icon icon-users icon-white"></i>
                    Contactos
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="total-conexiones">0</h4>
                <p class="mb-0">
                    <i class="icon icon-connections icon-white"></i>
                    Conexiones
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h4 id="densidad-red">0%</h4>
                <p class="mb-0">
                    <i class="icon icon-chart icon-white"></i>
                    Densidad
                </p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card stats-card-compact">
                <h5 id="mas-conectado" class="nombre-conectado">Cargando...</h5>
                <p class="mb-0">
                    <i class="icon icon-crown icon-white"></i>
                    M√°s Conectado
                </p>
            </div>
        </div>
    </div>    

    <!-- Contenedor del grafo -->
    <div class="row network-row">
        <div class="col-12 network-col">
            <div class="admin-panel admin-panel-compact">

                <!-- Controles principales -->
                <div class="controls-container">
                    <!-- Fila 1: Controles b√°sicos del grafo -->
                    <div class="controls-row mb-2">
                        <button class="btn btn-success btn-custom btn-sm me-2" onclick="centrarRed()">
                            <i class="icon icon-target icon-sm"></i>
                            Centrar Vista
                        </button>
                        <button class="btn btn-info btn-custom btn-sm me-2" onclick="togglePhysics()">
                            <i class="icon icon-lightning icon-sm"></i>
                            Activar F√≠sica
                        </button>
                        <button class="btn btn-warning btn-custom btn-sm me-2" onclick="randomizePositions()">
                            <i class="icon icon-shuffle icon-sm"></i>
                            Reorganizar
                        </button>
                        <button class="btn btn-primary btn-custom btn-sm" onclick="recargarDatos()">
                            <i class="icon icon-refresh icon-sm"></i>
                            Recargar
                        </button>
                    </div>
                    
                </div>
                
                <!-- El grafo -->
                <div id="network" class="network-container network-full-height"></div>
                
            </div>
        </div>
    </div>
    
</div>

<!-- Sistema de notificaciones pop-up -->
<div id="notifications-container" class="notifications-container"></div>

{% endblock %}

{% block scripts %}
<!-- Incluir el archivo JavaScript principal -->
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<!-- Incluir el nuevo archivo JavaScript para creaci√≥n de nodos -->
<script src="{{ url_for('static', filename='js/create-node.js') }}"></script>
<!-- Incluir el nuevo archivo JavaScript para creaci√≥n de aristas -->
<script src="{{ url_for('static', filename='js/create-edge.js') }}"></script>
<!-- Incluir las correcciones de accesibilidad -->
<script src="{{ url_for('static', filename='js/accessibility-fixes.js') }}"></script>
<!-- Incluir la correcci√≥n espec√≠fica para aria-hidden -->
<script src="{{ url_for('static', filename='js/aria-hidden-fix.js') }}"></script>

<script src="{{ url_for('static', filename='js/positions.js') }}"></script>
<!-- NUEVO: Incluir el parche de rendimiento para zoom -->

<script src="{{ url_for('static', filename='js/node-info-modal.js') }}"></script>

<script>
// Parche de rendimiento para zoom - INCLUIDO DIRECTAMENTE
console.log('‚ö° Cargando parche de rendimiento para zoom...');

// Variables para optimizaci√≥n de rendimiento
let lastTransformTime = 0;
let pendingTransform = false;

// Funci√≥n optimizada para aplicar transformaciones con throttling
function aplicarTransformacionOptimizada() {
    const now = performance.now();
    const deltaTime = now - lastTransformTime;
    
    // Throttling: no aplicar m√°s de 60fps
    if (deltaTime < 16.67) {
        if (!pendingTransform) {
            pendingTransform = true;
            requestAnimationFrame(() => {
                if (typeof aplicarTransformacionBurbujas === 'function') {
                    aplicarTransformacionBurbujas();
                }
                lastTransformTime = performance.now();
                pendingTransform = false;
            });
        }
        return;
    }
    
    if (typeof aplicarTransformacionBurbujas === 'function') {
        aplicarTransformacionBurbujas();
    }
    lastTransformTime = now;
}

// Mejorar los eventos de zoom despu√©s de que el sistema est√© listo
function aplicarMejorasZoom() {
    if (!network || typeof burbujasActivas === 'undefined') {
        console.log('‚è≥ Esperando sistema de burbujas para aplicar mejoras de zoom...');
        setTimeout(aplicarMejorasZoom, 1000);
        return;
    }
    
    console.log('‚ö° Aplicando mejoras de rendimiento de zoom...');
    
    // Sobreescribir la funci√≥n de aplicaci√≥n de transformaci√≥n con la versi√≥n optimizada
    if (typeof window.aplicarTransformacionBurbujas === 'function') {
        const originalFunction = window.aplicarTransformacionBurbujas;
        
        window.aplicarTransformacionBurbujas = function() {
            // Usar la versi√≥n optimizada cuando sea apropiado
            if (pendingTransform) {
                return; // Ya hay una transformaci√≥n pendiente
            }
            return originalFunction.apply(this, arguments);
        };
        
        console.log('‚úÖ Funci√≥n de transformaci√≥n optimizada');
    }
    
    // Funci√≥n para detectar zoom r√°pido y optimizar
    let lastZoomTime = 0;
    let zoomCount = 0;
    
    if (network) {
        network.on('zoom', function() {
            const now = performance.now();
            
            // Detectar zoom r√°pido (m√°s de 3 zooms en 1 segundo)
            if (now - lastZoomTime < 1000) {
                zoomCount++;
            } else {
                zoomCount = 1;
            }
            lastZoomTime = now;
            
            // Si es zoom r√°pido, usar funci√≥n optimizada
            if (zoomCount > 3) {
                aplicarTransformacionOptimizada();
            }
        });
        
        console.log('‚úÖ Optimizaci√≥n de zoom r√°pido configurada');
    }
}

// Aplicar mejoras cuando el DOM est√© listo
setTimeout(aplicarMejorasZoom, 3000);

// Funci√≥n de test para verificar las mejoras
window.testZoomOptimizado = function() {
    console.log('üß™ Probando zoom optimizado...');
    
    if (!network) {
        console.error('‚ùå Network no disponible');
        return;
    }
    
    let startTime = performance.now();
    let transformCount = 0;
    
    // Interceptar transformaciones para contar
    const original = window.aplicarTransformacionBurbujas;
    window.aplicarTransformacionBurbujas = function() {
        transformCount++;
        return original?.apply(this, arguments);
    };
    
    // Hacer zoom r√°pido
    const zooms = [0.5, 2, 0.8, 2.5, 1, 1.5, 1];
    let index = 0;
    
    function nextZoom() {
        if (index < zooms.length) {
            network.moveTo({ 
                scale: zooms[index], 
                animation: { duration: 200 } 
            });
            index++;
            setTimeout(nextZoom, 300);
        } else {
            // Mostrar resultados
            const totalTime = performance.now() - startTime;
            console.log(`‚ö° Test completado en ${totalTime.toFixed(0)}ms`);
            console.log(`üîÑ Transformaciones aplicadas: ${transformCount}`);
            console.log(`üìà FPS efectivo: ${(transformCount / (totalTime / 1000)).toFixed(1)}`);
            
            // Restaurar funci√≥n original
            window.aplicarTransformacionBurbujas = original;
            
            // Volver a la vista normal
            network.fit({ animation: { duration: 1000 } });
        }
    }
    
    nextZoom();
};

console.log('‚ö° Parche de rendimiento de zoom cargado');
</script>

<!-- NUEVO: Sistema de recuperaci√≥n autom√°tica -->
<script>
// Sistema de recuperaci√≥n autom√°tica - INCLUIDO DIRECTAMENTE
console.log('üõ†Ô∏è Cargando sistema de recuperaci√≥n autom√°tica...');

// Variables de estado del sistema
let sistemaConfigurado = false;
let intentosRecuperacion = 0;
const maxIntentosRecuperacion = 3;

// Funci√≥n para detectar si el sistema necesita recuperaci√≥n
function detectarNecesidadRecuperacion() {
    const problemas = [];
    
    // Verificar componentes b√°sicos
    if (typeof network === 'undefined' || !network) {
        problemas.push('Network no disponible');
    }
    
    if (typeof nodes === 'undefined' || !nodes) {
        problemas.push('Nodes no disponible');
    }
    
    // Verificar funcionalidades adicionales
    if (typeof configurarDobleClickCrearNodo !== 'function') {
        problemas.push('Funcionalidad de doble clic no configurada');
    }
    
    if (typeof configurarHoverCrearAristas !== 'function') {
        problemas.push('Funcionalidad de hover no configurada');
    }
    
    // Verificar sistema de burbujas
    if (typeof crearBurbujasGrupos !== 'function') {
        problemas.push('Sistema de burbujas no disponible');
    }
    
    // Verificar si hay burbujas cuando deber√≠a haberlas
    if (typeof burbujasActivas !== 'undefined' && burbujasActivas && nodes && nodes.length > 0) {
        const nodosConGrupos = nodes.get().filter(nodo => nodo.grupo && nodo.grupo !== 'sin_grupo');
        if (nodosConGrupos.length > 0) {
            const container = document.getElementById('network');
            const svg = container?.querySelector('.burbujas-svg');
            const burbujas = svg?.querySelectorAll('.burbuja-grupo');
            
            if (!burbujas || burbujas.length === 0) {
                problemas.push('Burbujas no visibles cuando deber√≠an estarlo');
            }
        }
    }
    
    return problemas;
}

// Funci√≥n para recuperar funcionalidades perdidas
async function recuperarSistema() {
    if (intentosRecuperacion >= maxIntentosRecuperacion) {
        console.warn('‚ö†Ô∏è M√°ximo de intentos de recuperaci√≥n alcanzado');
        return false;
    }
    
    intentosRecuperacion++;
    console.log(`üîß Intento de recuperaci√≥n ${intentosRecuperacion}/${maxIntentosRecuperacion}...`);
    
    try {
        // 1. Verificar y configurar funcionalidades b√°sicas
        if (network && typeof configurarDobleClickCrearNodo === 'function') {
            configurarDobleClickCrearNodo();
            console.log('‚úÖ Doble clic reconfigurado');
        }
        
        if (network && typeof configurarHoverCrearAristas === 'function') {
            configurarHoverCrearAristas();
            console.log('‚úÖ Hover para aristas reconfigurado');
        }
        
        // 2. Recuperar sistema de burbujas si es necesario
        if (nodes && nodes.length > 0) {
            const nodosConGrupos = nodes.get().filter(nodo => nodo.grupo && nodo.grupo !== 'sin_grupo');
            
            if (nodosConGrupos.length > 0) {
                console.log(`ü´ß Recuperando burbujas para ${nodosConGrupos.length} nodos con grupos...`);
                
                // Activar burbujas
                if (typeof burbujasActivas !== 'undefined') {
                    window.burbujasActivas = true;
                }
                
                // Crear burbujas
                if (typeof crearBurbujasGrupos === 'function') {
                    crearBurbujasGrupos();
                    console.log('‚úÖ Burbujas recuperadas');
                    
                    // Configurar eventos de burbujas
                    setTimeout(() => {
                        if (typeof configurarEventosBurbujas === 'function') {
                            configurarEventosBurbujas();
                            console.log('‚úÖ Eventos de burbujas reconfigurados');
                        }
                    }, 300);
                }
            }
        }
        
        console.log('üéâ Recuperaci√≥n del sistema completada');
        sistemaConfigurado = true;
        return true;
        
    } catch (error) {
        console.error('‚ùå Error durante recuperaci√≥n:', error);
        return false;
    }
}

// Funci√≥n para monitorear el estado del sistema
function iniciarMonitoreoRecuperacion() {
    let verificacionesConsecutivasBuenas = 0;
    
    const intervaloMonitoreo = setInterval(() => {
        // Si ya est√° configurado, verificaciones menos frecuentes
        if (sistemaConfigurado) {
            verificacionesConsecutivasBuenas++;
            
            // Despu√©s de 10 verificaciones buenas (30 segundos), reducir frecuencia
            if (verificacionesConsecutivasBuenas >= 10) {
                // Verificaci√≥n cada 15 segundos en lugar de cada 3
                if (verificacionesConsecutivasBuenas % 5 !== 0) {
                    return;
                }
            }
            
            const problemas = detectarNecesidadRecuperacion();
            if (problemas.length > 0) {
                console.log('‚ö†Ô∏è Detectados problemas, intentando recuperaci√≥n:', problemas);
                sistemaConfigurado = false;
                verificacionesConsecutivasBuenas = 0;
                setTimeout(recuperarSistema, 1000);
            }
            return;
        }
        
        // Verificaci√≥n completa si no est√° configurado
        const problemas = detectarNecesidadRecuperacion();
        
        if (problemas.length > 0) {
            setTimeout(recuperarSistema, 1000);
        } else {
            sistemaConfigurado = true;
            verificacionesConsecutivasBuenas = 0;
            console.log('‚úÖ Sistema verificado como funcionando correctamente');
        }
        
    }, 3000); // Verificar cada 3 segundos
    
    // Detener monitoreo despu√©s de 3 minutos si todo est√° estable
    setTimeout(() => {
        if (sistemaConfigurado && verificacionesConsecutivasBuenas >= 15) {
            clearInterval(intervaloMonitoreo);
            console.log('‚úÖ Monitoreo detenido - sistema estable por 3 minutos');
        }
    }, 180000); // 3 minutos
}

// Funci√≥n para diagn√≥stico completo
window.diagnosticoCompletoSistema = function() {
    console.log('üîç DIAGN√ìSTICO COMPLETO DEL SISTEMA:');
    console.log('====================================');
    
    // Estado b√°sico
    console.log('üìä Estado b√°sico:');
    console.log('- Sistema configurado:', sistemaConfigurado ? '‚úÖ' : '‚ùå');
    console.log('- Intentos recuperaci√≥n:', intentosRecuperacion);
    console.log('- Network disponible:', typeof network !== 'undefined' && network ? '‚úÖ' : '‚ùå');
    console.log('- Nodes disponible:', typeof nodes !== 'undefined' && nodes ? `‚úÖ (${nodes.length})` : '‚ùå');
    console.log('- Edges disponible:', typeof edges !== 'undefined' && edges ? `‚úÖ (${edges.length})` : '‚ùå');
    
    // Funcionalidades
    console.log('\nüõ†Ô∏è Funcionalidades:');
    console.log('- Doble clic crear nodos:', typeof configurarDobleClickCrearNodo === 'function' ? '‚úÖ' : '‚ùå');
    console.log('- Hover crear aristas:', typeof configurarHoverCrearAristas === 'function' ? '‚úÖ' : '‚ùå');
    console.log('- Sistema burbujas:', typeof crearBurbujasGrupos === 'function' ? '‚úÖ' : '‚ùå');
    console.log('- Gesti√≥n grupos:', typeof abrirModalGestionGrupos === 'function' ? '‚úÖ' : '‚ùå');
    console.log('- Persistencia grupos:', typeof sincronizarGruposAlCargar === 'function' ? '‚úÖ' : '‚ùå');
    
    // Estado de burbujas
    console.log('\nü´ß Sistema de burbujas:');
    if (typeof burbujasActivas !== 'undefined') {
        console.log('- Burbujas activas:', burbujasActivas ? '‚úÖ' : '‚ùå');
        
        if (burbujasActivas) {
            const container = document.getElementById('network');
            const svg = container?.querySelector('.burbujas-svg');
            const burbujas = svg?.querySelectorAll('.burbuja-grupo');
            
            console.log('- SVG presente:', svg ? '‚úÖ' : '‚ùå');
            console.log('- Burbujas en DOM:', burbujas ? `‚úÖ (${burbujas.length})` : '‚ùå');
        }
    } else {
        console.log('- Estado burbujas: ‚ùå No definido');
    }
    
    // Problemas detectados
    const problemas = detectarNecesidadRecuperacion();
    console.log('\n‚ö†Ô∏è Problemas detectados:');
    if (problemas.length === 0) {
        console.log('‚úÖ Ning√∫n problema detectado');
    } else {
        problemas.forEach((problema, index) => {
            console.log(`${index + 1}. ${problema}`);
        });
        
        console.log('\nüîß Ejecutando recuperaci√≥n autom√°tica...');
        setTimeout(recuperarSistema, 500);
    }
    
    console.log('\nüí° Funciones disponibles:');
    console.log('- recuperarSistemaManual() - Forzar recuperaci√≥n');
    console.log('- testBurbujasPostRecarga() - Test de burbujas');
    console.log('- verificarEstadoSistema() - Estado b√°sico');
    console.log('====================================');
    
    return problemas.length === 0;
};

// Funci√≥n para recuperaci√≥n manual
window.recuperarSistemaManual = async function() {
    console.log('üîß Iniciando recuperaci√≥n manual...');
    intentosRecuperacion = 0;
    sistemaConfigurado = false;
    
    const exito = await recuperarSistema();
    
    if (exito) {
        mostrarNotificacion('success', 'Sistema recuperado exitosamente');
    } else {
        mostrarNotificacion('error', 'Error en la recuperaci√≥n del sistema');
    }
    
    return exito;
};

// Funci√≥n espec√≠fica para test de burbujas
window.testBurbujasPostRecarga = function() {
    console.log('üß™ Test de burbujas post-recarga...');
    
    if (!nodes || nodes.length === 0) {
        console.log('‚ùå No hay nodos para probar');
        mostrarNotificacion('info', 'No hay nodos disponibles para probar burbujas');
        return false;
    }
    
    const nodosConGrupos = nodes.get().filter(nodo => nodo.grupo && nodo.grupo !== 'sin_grupo');
    
    if (nodosConGrupos.length === 0) {
        console.log('üìù No hay grupos asignados, creando grupos demo...');
        if (typeof crearGruposDemo === 'function') {
            crearGruposDemo();
            mostrarNotificacion('info', 'Grupos demo creados. Las burbujas aparecer√°n autom√°ticamente.');
            return true;
        } else {
            mostrarNotificacion('error', 'No se pueden crear grupos de demostraci√≥n');
            return false;
        }
    }
    
    // Verificar estado de burbujas
    const container = document.getElementById('network');
    const svg = container?.querySelector('.burbujas-svg');
    const burbujas = svg?.querySelectorAll('.burbuja-grupo');
    
    console.log(`ü´ß ${nodosConGrupos.length} nodos con grupos, ${burbujas?.length || 0} burbujas visibles`);
    
    if (!burbujas || burbujas.length === 0) {
        console.log('üîß Recreando burbujas...');
        if (typeof crearBurbujasGrupos === 'function') {
            window.burbujasActivas = true;
            crearBurbujasGrupos();
            mostrarNotificacion('success', 'Burbujas recreadas exitosamente');
        }
    } else {
        console.log('‚úÖ Burbujas ya est√°n visibles');
        mostrarNotificacion('success', 'Las burbujas est√°n funcionando correctamente');
    }
    
    return true;
};

// Inicializar monitoreo despu√©s de que todo est√© cargado
setTimeout(() => {
    if (typeof network !== 'undefined' && typeof nodes !== 'undefined') {
        console.log('üõ†Ô∏è Iniciando sistema de recuperaci√≥n autom√°tica...');
        iniciarMonitoreoRecuperacion();
    }
}, 5000); // Esperar 5 segundos para que todo se cargue

console.log('üõ†Ô∏è Sistema de recuperaci√≥n autom√°tica cargado');
</script>

<!-- NUEVOS SCRIPTS PARA PERSISTENCIA -->
<script>
// Incluir aqu√≠ las funciones de persistencia directamente en el HTML
// para asegurar que est√©n disponibles inmediatamente

// Funci√≥n para enviar updates de grupos al servidor
async function enviarActualizacionesGruposAlServidor(updates) {
    if (!updates || updates.length === 0) {
        console.log('üìù No hay actualizaciones de grupos para enviar');
        return { success: true, message: 'Sin cambios que guardar' };
    }
    
    try {
        console.log('üì§ Enviando actualizaciones de grupos al servidor:', updates);
        
        const response = await fetch('/actualizar_grupos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                updates: updates
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Respuesta del servidor:', result);
        
        return result;
        
    } catch (error) {
        console.error('‚ùå Error enviando actualizaciones de grupos:', error);
        throw error;
    }
}

// Funci√≥n para obtener grupos actuales del servidor
async function obtenerGruposDelServidor() {
    try {
        console.log('üì• Obteniendo grupos actuales del servidor...');
        
        const response = await fetch('/obtener_grupos_personas');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Grupos obtenidos del servidor:', result);
        
        return result.grupos || {};
        
    } catch (error) {
        console.error('‚ùå Error obteniendo grupos del servidor:', error);
        throw error;
    }
}

// Funci√≥n para sincronizar grupos al cargar la p√°gina
async function sincronizarGruposAlCargar() {
    console.log('üîÑ Sincronizando grupos al cargar...');
    
    try {
        // Obtener grupos actuales del servidor
        const gruposServidor = await obtenerGruposDelServidor();
        
        if (!nodes) {
            console.warn('‚ö†Ô∏è Nodes no disponible para sincronizaci√≥n');
            return;
        }
        
        // Comparar con grupos en memoria
        const nodosActuales = nodes.get();
        const actualizacionesNecesarias = [];
        
        nodosActuales.forEach(nodo => {
            const grupoServidor = gruposServidor[nodo.id]?.grupo;
            const grupoActual = nodo.grupo;
            
            if (grupoServidor !== grupoActual) {
                console.log(`üîÑ Sincronizando nodo ${nodo.id}: "${grupoActual}" ‚Üí "${grupoServidor}"`);
                
                actualizacionesNecesarias.push({
                    id: nodo.id,
                    grupo: grupoServidor
                });
            }
        });
        
        if (actualizacionesNecesarias.length > 0) {
            nodes.update(actualizacionesNecesarias);
            console.log(`‚úÖ ${actualizacionesNecesarias.length} grupos sincronizados`);
            
            // Crear burbujas despu√©s de sincronizar
            if (typeof crearBurbujasGrupos === 'function') {
                setTimeout(crearBurbujasGrupos, 500);
            }
        } else {
            console.log('‚úÖ Grupos ya sincronizados');
        }
        
    } catch (error) {
        console.error('‚ùå Error sincronizando grupos:', error);
    }
}

// Funci√≥n para verificar sincronizaci√≥n
window.verificarSincronizacionGrupos = async function() {
    console.log('üîç Verificando sincronizaci√≥n de grupos...');
    
    try {
        const gruposServidor = await obtenerGruposDelServidor();
        
        if (!nodes) {
            console.log('‚ùå Nodes no disponible');
            return false;
        }
        
        const nodosActuales = nodes.get();
        
        console.log('üìä COMPARACI√ìN DE GRUPOS:');
        console.log('========================');
        
        let diferencias = 0;
        
        nodosActuales.forEach(nodo => {
            const grupoMemoria = nodo.grupo || 'sin_grupo';
            const grupoServidor = gruposServidor[nodo.id]?.grupo || 'sin_grupo';
            const nombre = nodo.label?.replace(/<[^>]*>/g, '') || `Nodo ${nodo.id}`;
            
            if (grupoMemoria !== grupoServidor) {
                console.log(`‚ùå ${nombre}: Memoria="${grupoMemoria}" vs Servidor="${grupoServidor}"`);
                diferencias++;
            } else {
                console.log(`‚úÖ ${nombre}: "${grupoMemoria}" (sincronizado)`);
            }
        });
        
        console.log('========================');
        console.log(`üìà Resultado: ${diferencias === 0 ? '‚úÖ Totalmente sincronizado' : `‚ùå ${diferencias} diferencias encontradas`}`);
        
        return diferencias === 0;
        
    } catch (error) {
        console.error('‚ùå Error verificando sincronizaci√≥n:', error);
        return false;
    }
};

// Funci√≥n para diagnosticar problemas
window.diagnosticarProblemasPersistencia = async function() {
    console.log('üîç DIAGN√ìSTICO DE PERSISTENCIA:');
    console.log('==============================');
    
    const problemas = [];
    
    // 1. Verificar backend
    try {
        const response = await fetch('/actualizar_grupos', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates: [] })
        });
        
        if (response.ok) {
            console.log('‚úÖ Endpoint /actualizar_grupos disponible');
        } else {
            problemas.push('‚ùå Endpoint /actualizar_grupos no responde correctamente');
        }
    } catch (error) {
        problemas.push('‚ùå No se puede conectar con /actualizar_grupos: ' + error.message);
    }
    
    // 2. Verificar obtener grupos
    try {
        const grupos = await obtenerGruposDelServidor();
        console.log(`‚úÖ Endpoint /obtener_grupos_personas disponible (${Object.keys(grupos).length} personas)`);
    } catch (error) {
        problemas.push('‚ùå Error obteniendo grupos del servidor: ' + error.message);
    }
    
    // 3. Verificar dependencias
    if (typeof nodes === 'undefined' || !nodes) {
        problemas.push('‚ùå Variable nodes no disponible');
    } else {
        console.log(`‚úÖ Nodes disponible (${nodes.length} nodos)`);
    }
    
    if (typeof network === 'undefined' || !network) {
        problemas.push('‚ùå Variable network no disponible');
    } else {
        console.log('‚úÖ Network disponible');
    }
    
    console.log('==============================');
    
    if (problemas.length === 0) {
        console.log('üéâ ¬°No se encontraron problemas de persistencia!');
        await verificarSincronizacionGrupos();
    } else {
        console.log('üö® PROBLEMAS ENCONTRADOS:');
        problemas.forEach(problema => console.log(problema));
        mostrarNotificacion('error', 'Se encontraron problemas en el sistema de persistencia. Revisa la consola.');
    }
    
    return problemas.length === 0;
};

// Exportar funciones globalmente
window.enviarActualizacionesGruposAlServidor = enviarActualizacionesGruposAlServidor;
window.obtenerGruposDelServidor = obtenerGruposDelServidor;
window.sincronizarGruposAlCargar = sincronizarGruposAlCargar;

console.log('üíæ Sistema de persistencia de grupos cargado directamente');
</script>

<!-- Script CORREGIDO para integraci√≥n - SIN RECURSI√ìN -->
<script>
console.log('üöÄ Iniciando scripts de integraci√≥n con persistencia...');

// Funci√≥n CORREGIDA para mostrar estad√≠sticas de grupos - SIN RECURSI√ìN
window.mostrarEstadisticasGruposModal = function() {
    console.log('üìä Abriendo modal de estad√≠sticas de grupos...');
    
    // Verificar que los sistemas est√©n disponibles
    if (typeof obtenerEstadisticasGrupos !== 'function') {
        console.warn('‚ö†Ô∏è Funci√≥n obtenerEstadisticasGrupos no disponible');
        mostrarNotificacion('warning', 'Sistema de estad√≠sticas no disponible a√∫n. Intenta en unos segundos.');
        return;
    }
    
    try {
        // Llamar a la funci√≥n SIN recursi√≥n - usando la funci√≥n global
        const stats = obtenerEstadisticasGrupos();
        console.log('üìä Estad√≠sticas obtenidas:', stats);
        console.table(stats);
        
        // Crear modal para mostrar estad√≠sticas
        let html = `
            <div class="modal fade" id="modalEstadisticasGrupos" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="icon icon-chart"></i>
                                Estad√≠sticas de Grupos
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Grupo</th>
                                            <th>Nodos</th>
                                            <th>Conexiones Internas</th>
                                            <th>Conexiones Externas</th>
                                            <th>Densidad Interna</th>
                                            <th>Color</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        if (Object.keys(stats).length === 0) {
            html += '<tr><td colspan="6" class="text-center text-muted">No hay grupos con datos suficientes</td></tr>';
        } else {
            Object.entries(stats).forEach(([grupo, data]) => {
                const nombreFormateado = typeof formatearNombreGrupo === 'function' ? formatearNombreGrupo(grupo) : grupo;
                html += `
                    <tr>
                        <td><strong>${nombreFormateado}</strong></td>
                        <td><span class="badge bg-primary">${data.nodos}</span></td>
                        <td><span class="badge bg-success">${data.conexionesInternas}</span></td>
                        <td><span class="badge bg-info">${data.conexionesExternas}</span></td>
                        <td><span class="badge bg-warning">${data.densidad}</span></td>
                        <td>
                            <div style="width: 20px; height: 20px; background: ${data.color}; border-radius: 50%; border: 1px solid #ccc;"></div>
                        </td>
                    </tr>
                `;
            });
        }
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <h6><i class="icon icon-chart"></i> Explicaci√≥n:</h6>
                                <ul class="mb-0">
                                    <li><strong>Nodos:</strong> Cantidad de personas en el grupo</li>
                                    <li><strong>Conexiones Internas:</strong> Relaciones entre miembros del mismo grupo</li>
                                    <li><strong>Conexiones Externas:</strong> Relaciones con personas de otros grupos</li>
                                    <li><strong>Densidad Interna:</strong> Porcentaje de conexiones internas respecto al m√°ximo posible</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="if(typeof crearBurbujasGrupos === 'function') crearBurbujasGrupos()">
                                <i class="icon icon-refresh"></i> Actualizar Burbujas
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Limpiar modal anterior
        const modalAnterior = document.getElementById('modalEstadisticasGrupos');
        if (modalAnterior) {
            modalAnterior.remove();
        }
        
        // Agregar y mostrar nuevo modal
        document.body.insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('modalEstadisticasGrupos'));
        modal.show();
        
        console.log('‚úÖ Modal de estad√≠sticas mostrado correctamente');
        
    } catch (error) {
        console.error('‚ùå Error obteniendo estad√≠sticas:', error);
        mostrarNotificacion('error', 'Error al obtener estad√≠sticas de grupos: ' + error.message);
    }
};

// Funci√≥n para demostraci√≥n de grupos
window.crearGruposDemo = function() {
    console.log('üß™ Creando grupos de demostraci√≥n...');
    
    if (!nodes) {
        console.error('‚ùå Nodes no disponible');
        mostrarNotificacion('error', 'Sistema de nodos no disponible');
        return;
    }
    
    // Obtener todos los nodos
    const todosLosNodos = nodes.get();
    
    if (todosLosNodos.length < 4) {
        console.log('‚ö†Ô∏è Se necesitan al menos 4 nodos para la demo');
        mostrarNotificacion('info', 'Agrega m√°s personas para ver una mejor demostraci√≥n de grupos');
        return;
    }
    
    // Asignar grupos de ejemplo
    const updates = [];
    
    todosLosNodos.forEach((nodo, index) => {
        let grupo = null;
        
        // Distribuir nodos en grupos de ejemplo
        if (index % 4 === 0) {
            grupo = 'universidad';
        } else if (index % 4 === 1) {
            grupo = 'trabajo';
        } else if (index % 4 === 2) {
            grupo = 'cadiz';
        } else {
            grupo = 'amigos';
        }
        
        updates.push({
            id: nodo.id,
            grupo: grupo
        });
    });
    
    // Aplicar cambios en frontend
    nodes.update(updates);
    
    // Enviar cambios al servidor para persistencia
    enviarActualizacionesGruposAlServidor(updates).then(resultado => {
        if (resultado.success) {
            console.log('‚úÖ Grupos demo guardados en servidor');
            
            // Crear burbujas
            setTimeout(() => {
                if (typeof crearBurbujasGrupos === 'function') {
                    crearBurbujasGrupos();
                    console.log('‚úÖ Burbujas de grupos creadas');
                }
            }, 500);
            
            mostrarNotificacion('success', '¬°Grupos de demostraci√≥n creados y guardados! Ahora puedes ver las burbujas de colores.');
        } else {
            console.error('‚ùå Error guardando grupos demo');
            mostrarNotificacion('error', 'Error guardando grupos de demostraci√≥n');
        }
    }).catch(error => {
        console.error('‚ùå Error enviando grupos demo al servidor:', error);
        mostrarNotificacion('error', 'Error de conexi√≥n al guardar grupos demo');
    });
    
    console.log('‚úÖ Grupos demo aplicados a', updates.length, 'nodos');
};

// Funci√≥n para limpiar grupos demo
window.limpiarGruposDemo = function() {
    console.log('üßπ Limpiando grupos de demostraci√≥n...');
    
    if (!nodes) {
        console.error('‚ùå Nodes no disponible');
        return;
    }
    
    const todosLosNodos = nodes.get();
    const updates = todosLosNodos.map(nodo => ({
        id: nodo.id,
        grupo: null
    }));
    
    // Aplicar cambios en frontend
    nodes.update(updates);
    
    // Enviar cambios al servidor
    enviarActualizacionesGruposAlServidor(updates).then(resultado => {
        if (resultado.success) {
            console.log('‚úÖ Grupos limpiados en servidor');
        }
    }).catch(error => {
        console.error('‚ùå Error limpiando grupos en servidor:', error);
    });
    
    if (typeof limpiarBurbujasAnteriores === 'function') {
        limpiarBurbujasAnteriores();
        console.log('‚úÖ Burbujas limpiadas');
    }
    
    mostrarNotificacion('info', 'Grupos de demostraci√≥n eliminados');
    console.log('‚úÖ Grupos demo eliminados de', updates.length, 'nodos');
};

// Funci√≥n mejorada para mostrar notificaci√≥n
function mostrarNotificacion(tipo, mensaje, duracion = 5000) {
    // Crear contenedor de notificaciones si no existe
    let container = document.getElementById('notifications-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notifications-container';
        container.className = 'notifications-container';
        document.body.appendChild(container);
    }
    
    // Crear notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `notification notification-${tipo}`;
    
    const iconos = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    
    notificacion.innerHTML = `
        <span class="notification-icon">${iconos[tipo] || '‚ÑπÔ∏è'}</span>
        <span class="notification-message">${mensaje}</span>
        <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;
    
    container.appendChild(notificacion);
    
    // Mostrar notificaci√≥n
    setTimeout(() => {
        notificacion.classList.add('notification-show');
    }, 100);
    
    // Auto-eliminar despu√©s de la duraci√≥n especificada
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.classList.remove('notification-show');
            setTimeout(() => {
                if (notificacion.parentNode) {
                    notificacion.remove();
                }
            }, 300);
        }
    }, duracion);
}

// Funci√≥n de debug global para probar todo el sistema
window.debugSistemaCompleto = function() {
    console.log('üîç DEBUG DEL SISTEMA COMPLETO CON PERSISTENCIA:');
    console.log('===============================================');
    
    // Verificar componentes principales
    console.log('üìä Red principal:', typeof network !== 'undefined' && network ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('üë• Nodos:', typeof nodes !== 'undefined' && nodes ? `‚úÖ Disponible (${nodes.length} nodos)` : '‚ùå No disponible');
    console.log('üîó Aristas:', typeof edges !== 'undefined' && edges ? `‚úÖ Disponible (${edges.length} aristas)` : '‚ùå No disponible');
    
    // Verificar sistemas adicionales
    console.log('üéØ Creaci√≥n nodos:', typeof configurarDobleClickCrearNodo === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('üîó Creaci√≥n aristas:', typeof configurarHoverCrearAristas === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('ü´ß Sistema burbujas:', typeof crearBurbujasGrupos === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('üìã Gesti√≥n grupos:', typeof abrirModalGestionGrupos === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    
    // Verificar persistencia
    console.log('üíæ Persistencia grupos:', typeof enviarActualizacionesGruposAlServidor === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('üì• Obtener grupos:', typeof obtenerGruposDelServidor === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    console.log('üîÑ Sincronizaci√≥n:', typeof sincronizarGruposAlCargar === 'function' ? '‚úÖ Disponible' : '‚ùå No disponible');
    
    // Estado de burbujas
    if (typeof burbujasActivas !== 'undefined') {
        console.log('ü´ß Burbujas activas:', burbujasActivas ? '‚úÖ Activadas' : '‚ùå Desactivadas');
        console.log('üé® Opacidad burbujas:', typeof opacidadBurbujas !== 'undefined' ? opacidadBurbujas : 'N/A');
    } else {
        console.log('ü´ß Estado burbujas: No disponible');
    }
    
    // Estad√≠sticas de grupos (SIN RECURSI√ìN)
    try {
        if (typeof obtenerEstadisticasGrupos === 'function') {
            const stats = obtenerEstadisticasGrupos();
            console.log('üìä Estad√≠sticas grupos disponibles:', Object.keys(stats).length, 'grupos');
            console.table(stats);
        } else {
            console.log('üìä Estad√≠sticas grupos: No disponible a√∫n');
        }
    } catch (error) {
        console.log('üìä Estad√≠sticas grupos: Error -', error.message);
    }
    
    // Bootstrap
    console.log('üÖ±Ô∏è Bootstrap:', typeof bootstrap !== 'undefined' ? '‚úÖ Disponible' : '‚ùå No disponible');
    
    console.log('===============================================');
    console.log('üí° Funciones de prueba disponibles:');
    console.log('- crearGruposDemo() - Crear grupos de demostraci√≥n (CON PERSISTENCIA)');
    console.log('- limpiarGruposDemo() - Limpiar grupos demo (CON PERSISTENCIA)');
    console.log('- verificarSincronizacionGrupos() - Verificar sincronizaci√≥n con servidor');
    console.log('- diagnosticarProblemasPersistencia() - Diagnosticar problemas');
    console.log('- mostrarEstadisticasGruposModal() - Ver estad√≠sticas en modal');
    console.log('===============================================');
};

// Mostrar mensaje de bienvenida cuando todo est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM cargado, esperando sistemas con persistencia...');
    
    setTimeout(function() {
        // Verificar si todo est√° cargado
        const sistemaCompleto = (
            typeof network !== 'undefined' && network &&
            typeof crearBurbujasGrupos === 'function' &&
            typeof abrirModalGestionGrupos === 'function' &&
            typeof enviarActualizacionesGruposAlServidor === 'function'
        );
        
        if (sistemaCompleto) {
            console.log('üéâ ¬°Sistema completo de red social con grupos Y PERSISTENCIA cargado exitosamente!');
            console.log('üíæ Los grupos ahora se guardan autom√°ticamente en el servidor');
            console.log('üîÑ Al recargar la p√°gina, los grupos se mantienen');
            console.log('üí° Ejecuta debugSistemaCompleto() para ver el estado completo');
            console.log('üß™ Ejecuta crearGruposDemo() para ver una demostraci√≥n de grupos PERSISTENTES');
            console.log('üîç Ejecuta diagnosticarProblemasPersistencia() para verificar el sistema');
            console.log('‚ú® ¬°Todo listo para usar con persistencia completa!');
            
            // Sincronizar grupos autom√°ticamente al cargar
            setTimeout(async () => {
                try {
                    await sincronizarGruposAlCargar();
                    console.log('üîÑ Sincronizaci√≥n autom√°tica completada');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error en sincronizaci√≥n autom√°tica:', error);
                }
            }, 1000);
            
        } else {
            console.log('‚è≥ Sistema a√∫n cargando... ejecuta debugSistemaCompleto() para ver el estado');
        }
    }, 3000);
});

console.log('‚úÖ Scripts de integraci√≥n con persistencia cargados correctamente');
</script>
{% endblock %}